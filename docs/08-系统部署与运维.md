# 系统部署与运维

## 功能概述

系统部署与运维是JoyAgent-JDGenie的生产环境支撑体系，提供完整的部署方案、监控告警、日志管理、性能优化等功能。系统支持多种部署模式（Docker、Kubernetes、传统部署），具备完善的运维工具和自动化能力。

## 业务功能实现

### 1. 部署方案

#### 1.1 Docker一键部署
```bash
# 1. 克隆项目
git clone https://github.com/jd-opensource/joyagent-jdgenie.git

# 2. 更新配置文件
# 更新 genie-backend/src/main/resources/application.yml 中的配置
# 更新 genie-tool/.env_template 中的环境变量

# 3. 构建Docker镜像
docker build -t genie:latest .

# 4. 启动容器
docker run -d -p 3000:3000 -p 8080:8080 -p 1601:1601 --name genie-app genie:latest

# 5. 访问系统
# 浏览器输入 localhost:3000 访问genie
```

#### 1.2 Dockerfile配置
```dockerfile
# 多阶段构建Dockerfile
FROM openjdk:17-jdk-slim AS backend-builder
WORKDIR /app
COPY genie-backend/ .
RUN ./mvnw clean package -DskipTests

FROM python:3.11-slim AS tool-builder
WORKDIR /app
COPY genie-tool/ .
RUN pip install uv && uv sync

FROM node:18-alpine AS frontend-builder
WORKDIR /app
COPY ui/ .
RUN npm install && npm run build

# 最终镜像
FROM openjdk:17-jdk-slim
WORKDIR /app

# 安装Python和Node.js
RUN apt-get update && apt-get install -y \
    python3.11 \
    python3-pip \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# 复制后端应用
COPY --from=backend-builder /app/target/genie-backend-*.jar /app/genie-backend.jar

# 复制Python工具服务
COPY --from=tool-builder /app /app/genie-tool
COPY --from=tool-builder /app/.venv /app/genie-tool/.venv

# 复制前端应用
COPY --from=frontend-builder /app/dist /app/ui/dist

# 复制启动脚本
COPY start_genie.sh /app/
RUN chmod +x /app/start_genie.sh

# 暴露端口
EXPOSE 3000 8080 1601 8188

# 启动命令
CMD ["/app/start_genie.sh"]
```

#### 1.3 Kubernetes部署
```yaml
# genie-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: genie-deployment
  labels:
    app: genie
spec:
  replicas: 3
  selector:
    matchLabels:
      app: genie
  template:
    metadata:
      labels:
        app: genie
    spec:
      containers:
      - name: genie-backend
        image: genie:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: JAVA_OPTS
          value: "-Xmx2g -Xms1g"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: genie-service
spec:
  selector:
    app: genie
  ports:
  - name: http
    port: 80
    targetPort: 8080
  type: LoadBalancer

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: genie-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: genie.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: genie-service
            port:
              number: 80
```

### 2. 配置管理

#### 2.1 环境配置
```yaml
# application.yml
spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  
  datasource:
    url: ${DATABASE_URL:jdbc:sqlite:genie.db}
    username: ${DATABASE_USERNAME:}
    password: ${DATABASE_PASSWORD:}
  
  jpa:
    hibernate:
      ddl-auto: ${DDL_AUTO:update}
    show-sql: ${SHOW_SQL:false}

# LLM配置
llm:
  default_model: ${DEFAULT_MODEL:gpt-4}
  models:
    gpt-4:
      api_key: ${OPENAI_API_KEY}
      base_url: ${OPENAI_BASE_URL:https://api.openai.com/v1}
      max_tokens: ${MAX_TOKENS:4096}
      temperature: ${TEMPERATURE:0.7}
  
  deepseek-chat:
    api_key: ${DEEPSEEK_API_KEY}
    base_url: ${DEEPSEEK_BASE_URL:https://api.deepseek.com}
    max_tokens: ${DEEPSEEK_MAX_TOKENS:8192}

# 工具服务配置
tools:
  code_interpreter_url: ${CODE_INTERPRETER_URL:http://localhost:1601}
  deep_search_url: ${DEEP_SEARCH_URL:http://localhost:1601}
  mcp_client_url: ${MCP_CLIENT_URL:http://localhost:8188}
  mcp_server_url: ${MCP_SERVER_URL:}

# 文件存储配置
storage:
  type: ${STORAGE_TYPE:local}
  local:
    path: ${STORAGE_PATH:/data/files}
  s3:
    bucket: ${S3_BUCKET:}
    region: ${S3_REGION:}
    access_key: ${S3_ACCESS_KEY:}
    secret_key: ${S3_SECRET_KEY:}
```

#### 2.2 环境变量管理
```bash
# .env.production
# 数据库配置
DATABASE_URL=jdbc:postgresql://db.example.com:5432/genie
DATABASE_USERNAME=genie_user
DATABASE_PASSWORD=secure_password

# LLM配置
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.openai.com/v1
DEFAULT_MODEL=gpt-4
MAX_TOKENS=4096
TEMPERATURE=0.7

# 工具服务配置
CODE_INTERPRETER_URL=http://tool-service:1601
DEEP_SEARCH_URL=http://tool-service:1601
MCP_CLIENT_URL=http://mcp-client:8188
MCP_SERVER_URL=https://mcp.example.com

# 存储配置
STORAGE_TYPE=s3
S3_BUCKET=genie-files
S3_REGION=us-east-1
S3_ACCESS_KEY=AKIAXXXXXXXXXXXXXXXX
S3_SECRET_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# 监控配置
PROMETHEUS_ENABLED=true
GRAFANA_ENABLED=true
```

### 3. 监控告警

#### 3.1 Prometheus监控
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "genie_rules.yml"

scrape_configs:
  - job_name: 'genie-backend'
    static_configs:
      - targets: ['genie-backend:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s

  - job_name: 'genie-tool'
    static_configs:
      - targets: ['genie-tool:1601']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'genie-mcp-client'
    static_configs:
      - targets: ['genie-mcp-client:8188']
    metrics_path: '/metrics'
    scrape_interval: 10s
```

#### 3.2 监控指标
```java
// 自定义监控指标
@Component
public class GenieMetrics {
    private final Counter requestCounter;
    private final Counter errorCounter;
    private final Timer responseTimer;
    private final Gauge activeConnections;
    
    public GenieMetrics(MeterRegistry meterRegistry) {
        this.requestCounter = Counter.builder("genie_requests_total")
            .description("Total number of requests")
            .register(meterRegistry);
        
        this.errorCounter = Counter.builder("genie_errors_total")
            .description("Total number of errors")
            .register(meterRegistry);
        
        this.responseTimer = Timer.builder("genie_response_time")
            .description("Response time")
            .register(meterRegistry);
        
        this.activeConnections = Gauge.builder("genie_active_connections")
            .description("Active SSE connections")
            .register(meterRegistry, this, GenieMetrics::getActiveConnections);
    }
    
    public void incrementRequests() {
        requestCounter.increment();
    }
    
    public void incrementErrors() {
        errorCounter.increment();
    }
    
    public Timer.Sample startTimer() {
        return Timer.start();
    }
    
    public void stopTimer(Timer.Sample sample) {
        sample.stop(responseTimer);
    }
    
    private double getActiveConnections() {
        return SSEConnectionManager.getInstance().getActiveConnections();
    }
}
```

#### 3.3 告警规则
```yaml
# genie_rules.yml
groups:
  - name: genie_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(genie_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, genie_response_time_seconds) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }} seconds"

      - alert: TooManyActiveConnections
        expr: genie_active_connections > 1000
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Too many active connections"
          description: "Active connections: {{ $value }}"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "Service {{ $labels.instance }} is down"
```

### 4. 日志管理

#### 4.1 日志配置
```xml
<!-- logback-spring.xml -->
<configuration>
    <springProfile name="dev">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/genie/genie.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>/var/log/genie/genie.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                    <maxFileSize>100MB</maxFileSize>
                </timeBasedFileNamingAndTriggeringPolicy>
                <maxHistory>30</maxHistory>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>

        <appender name="JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/genie/genie-json.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>/var/log/genie/genie-json.%d{yyyy-MM-dd}.log</fileNamePattern>
                <maxHistory>7</maxHistory>
            </rollingPolicy>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <message/>
                    <mdc/>
                    <stackTrace/>
                </providers>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="JSON"/>
        </root>
    </springProfile>
</configuration>
```

#### 4.2 结构化日志
```java
// 结构化日志记录
@Component
public class StructuredLogger {
    private static final Logger logger = LoggerFactory.getLogger(StructuredLogger.class);
    
    public void logRequest(String requestId, String sessionId, String query, long startTime) {
        MDC.put("requestId", requestId);
        MDC.put("sessionId", sessionId);
        MDC.put("query", query);
        MDC.put("startTime", String.valueOf(startTime));
        
        logger.info("Request started", Map.of(
            "event", "request_started",
            "requestId", requestId,
            "sessionId", sessionId,
            "query", query,
            "startTime", startTime
        ));
    }
    
    public void logToolCall(String requestId, String toolName, Object arguments, long duration) {
        logger.info("Tool called", Map.of(
            "event", "tool_called",
            "requestId", requestId,
            "toolName", toolName,
            "arguments", arguments,
            "duration", duration
        ));
    }
    
    public void logError(String requestId, String error, Exception exception) {
        logger.error("Error occurred", Map.of(
            "event", "error",
            "requestId", requestId,
            "error", error,
            "exception", exception.getMessage()
        ), exception);
    }
}
```

## 技术方案支撑

### 1. 自动化部署

#### 1.1 CI/CD流水线
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Run tests
      run: |
        cd genie-backend && ./mvnw test
        cd ../genie-tool && python -m pytest
        cd ../ui && npm test

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: docker build -t genie:${{ github.sha }} .
    
    - name: Push to registry
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker tag genie:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/genie:${{ github.sha }}
        docker push ${{ secrets.DOCKER_REGISTRY }}/genie:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/genie-deployment genie=${{ secrets.DOCKER_REGISTRY }}/genie:${{ github.sha }}
        kubectl rollout status deployment/genie-deployment
```

#### 1.2 健康检查脚本
```bash
#!/bin/bash
# health_check.sh

# 检查服务健康状态
check_service() {
    local service_url=$1
    local service_name=$2
    
    echo "Checking $service_name..."
    response=$(curl -s -o /dev/null -w "%{http_code}" "$service_url/health")
    
    if [ "$response" = "200" ]; then
        echo "✅ $service_name is healthy"
        return 0
    else
        echo "❌ $service_name is unhealthy (HTTP $response)"
        return 1
    fi
}

# 检查所有服务
check_service "http://localhost:8080" "Backend"
check_service "http://localhost:1601" "Tool Service"
check_service "http://localhost:8188" "MCP Client"
check_service "http://localhost:3000" "Frontend"

# 检查数据库连接
echo "Checking database connection..."
if pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; then
    echo "✅ Database is healthy"
else
    echo "❌ Database is unhealthy"
    exit 1
fi

# 检查磁盘空间
echo "Checking disk space..."
disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$disk_usage" -lt 90 ]; then
    echo "✅ Disk space is sufficient ($disk_usage%)"
else
    echo "❌ Disk space is low ($disk_usage%)"
    exit 1
fi

echo "All health checks passed!"
```

### 2. 性能优化

#### 2.1 JVM调优
```bash
# JVM启动参数
JAVA_OPTS="-server \
  -Xms2g \
  -Xmx4g \
  -XX:MetaspaceSize=256m \
  -XX:MaxMetaspaceSize=512m \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+UnlockExperimentalVMOptions \
  -XX:+UseStringDeduplication \
  -XX:+UseCompressedOops \
  -XX:+UseCompressedClassPointers \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/genie/heapdump.hprof \
  -XX:+PrintGCDetails \
  -XX:+PrintGCTimeStamps \
  -Xloggc:/var/log/genie/gc.log"
```

#### 2.2 数据库优化
```sql
-- 数据库索引优化
CREATE INDEX idx_files_request_id ON files(request_id);
CREATE INDEX idx_files_created_at ON files(created_at);
CREATE INDEX idx_messages_session_id ON messages(session_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);

-- 分区表（PostgreSQL）
CREATE TABLE files_partitioned (
    id BIGSERIAL,
    file_id VARCHAR(255),
    file_name VARCHAR(255),
    request_id VARCHAR(255),
    created_at TIMESTAMP,
    content TEXT
) PARTITION BY RANGE (created_at);

CREATE TABLE files_2024_01 PARTITION OF files_partitioned
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE files_2024_02 PARTITION OF files_partitioned
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

### 3. 安全配置

#### 3.1 网络安全
```yaml
# nginx配置
server {
    listen 80;
    server_name genie.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name genie.example.com;
    
    ssl_certificate /etc/ssl/certs/genie.crt;
    ssl_certificate_key /etc/ssl/private/genie.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
    
    # 代理配置
    location / {
        proxy_pass http://genie-backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 静态文件
    location /static/ {
        alias /var/www/genie/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 3.2 应用安全
```java
// 安全配置
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/actuator/health").permitAll()
                .requestMatchers("/web/api/v1/**").authenticated()
                .anyRequest().authenticated()
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            .addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

## 常见问题

### 1. 部署问题
**问题**：容器启动失败
**解决方案**：
- 检查配置文件
- 验证环境变量
- 查看启动日志
- 检查端口占用

### 2. 性能问题
**问题**：系统响应慢
**解决方案**：
- JVM调优
- 数据库优化
- 缓存策略
- 负载均衡

### 3. 监控问题
**问题**：监控数据不准确
**解决方案**：
- 检查指标收集
- 验证告警规则
- 调整采样频率
- 优化查询性能

## 系统设计

### 1. 部署架构
```
负载均衡层
├── Nginx/HAProxy        // 负载均衡
├── SSL终止             // HTTPS处理
└── 静态文件服务         // 前端资源

应用层
├── Genie Backend       // Java后端服务
├── Genie Tool          // Python工具服务
├── MCP Client          // MCP客户端
└── Frontend            // React前端

数据层
├── PostgreSQL          // 主数据库
├── Redis               // 缓存
└── MinIO/S3            // 文件存储

监控层
├── Prometheus          // 指标收集
├── Grafana             // 可视化
├── AlertManager        // 告警管理
└── ELK Stack           // 日志管理
```

### 2. 高可用设计
- 多实例部署
- 自动故障转移
- 数据备份恢复
- 灾难恢复计划

### 3. 扩展性设计
- 水平扩展
- 微服务架构
- 容器化部署
- 云原生支持

## 可扩展性

### 1. 部署模式扩展
- 支持更多云平台
- 混合云部署
- 边缘计算部署
- 多区域部署

### 2. 监控扩展
- 自定义指标
- 业务监控
- 用户体验监控
- 成本监控

### 3. 安全扩展
- 身份认证
- 权限管理
- 数据加密
- 审计日志

## 高可用性

### 1. 故障恢复
- 自动重启
- 健康检查
- 故障转移
- 数据恢复

### 2. 负载均衡
- 多实例部署
- 流量分发
- 会话保持
- 动态扩缩容

### 3. 数据保护
- 定期备份
- 增量备份
- 异地备份
- 数据恢复测试

## 通用性

### 1. 跨平台支持
- Linux/Windows/macOS
- 云平台兼容
- 容器化部署
- 虚拟化支持

### 2. 标准化部署
- 基础设施即代码
- 配置管理
- 自动化部署
- 版本控制

### 3. 运维工具
- 监控告警
- 日志管理
- 性能分析
- 故障排查

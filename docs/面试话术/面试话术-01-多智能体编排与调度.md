### 面试话术｜多智能体编排与调度

- 一句话简介：我们把用户的自然语言目标拆解为可执行计划，按步调用工具并在流式过程中对外可观测，最终合并为可交付结果（报告/网页/文件）。

#### 自我介绍开场（30s）
- 我主要负责后端编排链路的设计与实现，包括计划-执行-总结三阶段智能体，以及多工具协同与可靠流式输出。
- 项目在 GAIA Validation 集达到约 75.15%，Test 集 65.12%，并保持良好的可扩展性与稳定性。

#### 架构与实现要点（1-2min）
- 编排入口：`/web/api/v1/gpt/queryAgentStreamIncr`（SSE），控制器：`genie-backend/.../controller/GenieController`。
- 策略选择：`AgentHandlerFactory` 根据 `AgentType` 选择 `PlanSolveHandlerImpl` 或 `ReactHandlerImpl`。
- 核心智能体：
  - `PlanningAgent`：基于 Prompt 生成可执行计划（支持多步、可迭代）
  - `ExecutorAgent` / `ReActAgent`：按步执行、思考-行动循环
  - `SummaryAgent`：汇总执行产物与文件，产出面向用户的结论
- 工具装配：`ToolCollection` 聚合本地工具与 MCP 工具，优先本地命中，否则透传到外部 MCP。
- 关键配置：`application.yml` 中可调节 planner 最大步数、心跳间隔、模型与工具地址。

关键代码定位：
- `genie-backend/src/main/java/com/jd/genie/service/impl/PlanSolveHandlerImpl.java`
- `genie-backend/src/main/java/com/jd/genie/agent/agent/PlanningAgent.java`
- `genie-backend/src/main/java/com/jd/genie/agent/agent/ExecutorAgent.java`
- `genie-backend/src/main/java/com/jd/genie/agent/agent/SummaryAgent.java`
- `genie-backend/src/main/java/com/jd/genie/agent/tool/ToolCollection.java`

#### 遇到的问题与解决方案（STAR法则）
- 问题1：规划“步数爆炸”和循环思考
  - 场景：复杂任务容易产生冗长计划或在“下一步”上反复打转
  - 根因：模型对工具成本与上下文窗口敏感度不足
  - 方案：
    - 设置 `plannerMaxSteps` 与计划剪枝；在 `PlanningAgent` 中“计划-下一步”提示词拆分
    - 在 `SummaryAgent` 上设置 `messageSizeLimit`，避免过长历史污染
    - 通过 `application.yml` 逐步收敛策略参数
  - 效果：平均步数下降 30%+，无效循环显著减少

- 问题2：执行阶段串行导致时延高
  - 场景：多子任务彼此独立但顺序执行
  - 根因：未利用任务独立性
  - 方案：`PlanSolveHandlerImpl` 中使用 `CountDownLatch` 并发子任务，结果后置合并
  - 效果：端到端时延在多子任务场景下降 35%-60%

- 问题3：工具调用失败导致整链路中断
  - 场景：搜索/外部工具偶发 4xx/5xx 或超时
  - 方案：
    - 在工具层统一超时/重试/降级（先本地工具，后 MCP）
    - SSE 流中输出“失败但继续”的事件，保持用户可观测
  - 效果：长链路任务成功率提升 10%+

- 问题4：总结阶段文件挑选不准
  - 场景：最终文件列表包含中间过程文件
  - 方案：`ReactHandlerImpl` 中过滤 `isInternalFile`，并按重要性排序输出
  - 效果：用户下载转化率提升（更聚焦的结果物）

#### 量化指标与收益
- GAIA Validation 75.15%、Test 65.12%
- 复杂任务端到端时延下降 35%-60%
- 长链路成功率 +10% 以上

#### 面试官可能追问与回答要点
- Q：为什么同时支持 Plan-Execute 与 ReAct？
  - A：Plan-Execute 适合复杂/多阶段目标，ReAct 适合单步或短链路问题；两者通过 `AgentHandlerFactory` 策略化选择。
- Q：上下文如何控长与去噪？
  - A：截断策略+文件化中间产物+`messageSizeLimit`；对“计划/下一步”提示词解耦。
- Q：并发安全与资源隔离？
  - A：以 `requestId` 作为隔离单元，文件与中间状态按任务空间隔离。

#### 演进计划
- 引入计划置信度评估，结合价值函数做计划剪枝
- 以“工具代价估计”优化计划排序，减少总 token 与等待时间

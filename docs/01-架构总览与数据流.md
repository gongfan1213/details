### 架构总览与数据流

本项目由前端 UI、Java 后端、Python 工具服务、MCP 客户端四大模块组成，协同完成「任务规划→工具调用→结果生成→流式呈现」。

#### 模块职责
- **UI (`ui/`)**：聊天界面、任务进度与文件结果展示。通过 `querySSE.ts` 使用 `@microsoft/fetch-event-source` 与后端建立 SSE 连接。
- **后端 (`genie-backend/`)**：
  - 提供统一入口 `POST /web/api/v1/gpt/queryAgentStreamIncr`（SSE）
  - 编排智能体：规划（Planning）、执行（Executor/React）与总结（Summary），内部通过 `AgentHandlerFactory` 选择不同策略
  - 统一对接 LLM、Python 工具服务与 MCP 客户端
- **Python 工具服务 (`genie-tool/`)**：
  - `code_interpreter` 代码执行、`report` 报告生成、`deepsearch` 深度搜索
  - `file_tool` 文件上传/下载/预览与列表
  - 支持流式 SSE 与非流式返回
- **MCP 客户端 (`genie-client/`)**：封装与外部 MCP Server（如地图、票务等）的 SSE 协议交互，提供 `list` 与 `call` 等 API 给后端使用

#### 核心链路（请求→响应）
1) UI 侧在 `ChatView` 组装请求体（`sessionId/requestId/query/deepThink/outputStyle`）
2) 通过 `POST /web/api/v1/gpt/queryAgentStreamIncr` 与后端建立 SSE
3) 后端接收请求后，转交多智能体编排与调度（必要时进一步调用 `/AutoAgent`）
4) 智能体在任务执行过程中，按需调用：
   - Python 工具服务：`/v1/tool/code_interpreter|report|deepsearch`
   - MCP 客户端：`/v1/tool/list|call` 与外部 MCP Server 通信
5) 后端将阶段事件和最终结果以 SSE 数据包逐条推送至前端（包括周期性 `heartbeat`）
6) UI 根据事件类型更新计划视图、任务面板与文件预览

#### 关键技术点
- **SSE（Server-Sent Events）**：
  - 后端 `GenieController` 中的 `queryAgentStreamIncr` 返回 `SseEmitter`，定时发送 `heartbeat`
  - Python 工具服务在流式模式下返回 `EventSourceResponse`，同样包含心跳
- **可插拔工具**：
  - Java 侧 `ToolCollection` 聚合工具（文件、搜索、报告、代码执行、MCP）
  - 通过配置 `application.yml` 可动态调整工具服务与 MCP 服务地址
- **多智能体调度**：
  - 规划/执行/总结各阶段的 Prompt 与流程控制集中在 `application.yml` 的 `autobots` 配置中，方便快速迭代

#### 端口与依赖服务
- UI：`3000`
- 后端：`8080`
- Python 工具服务：`1601`
- MCP 客户端：`8188`

#### 典型时序（简化）
```
User → UI(ChatView) → POST /web/api/v1/gpt/queryAgentStreamIncr (SSE)
                                         ↓
                                    后端编排(AgentHandler)
                                         ↓
             ┌──────────── Python 工具(1601) ────────────┐
             │   /v1/tool/code_interpreter /report /deepsearch  │
             └──────────────────────────┬───────────────────────┘
                                        │
                                 MCP 客户端(8188)
                              /v1/tool/list /call → MCP Server

SSE ← 流式事件返回（计划、执行进度、结果文件、heartbeat） ← 后端
```



æˆ‘å…ˆå…¨å±€æœä¸€ä¸‹é¡¹ç›®é‡Œä¸ç¨³å®šæ€§ï¼ˆé‡è¯•ã€è¶…æ—¶ã€ç†”æ–­ã€å¥åº·æ£€æŸ¥ã€å¹¶å‘æ§åˆ¶ï¼‰ä»¥åŠæµé‡æ§åˆ¶ï¼ˆé™æµã€é˜Ÿåˆ—ã€èƒŒå‹ã€é™çº§ï¼‰ç›¸å…³çš„å®ç°ä½ç½®ï¼Œç„¶åå†ç»™ä½ é’ˆå¯¹æœ¬é¡¹ç›®çš„æ¦‚è§ˆè¯´æ˜å’Œå…³é”®æ–‡ä»¶ä½ç½®ã€‚

[5 tools called]

æˆ‘å·²ç»å®šä½åˆ°æœ¬é¡¹ç›®é‡Œâ€œç¨³å®šæ€§ä¿éšœâ€å’Œâ€œæµé‡è¶…é™ï¼ˆæº¢å‡ºï¼‰åº”å¯¹â€çš„æ ¸å¿ƒå®ç°ç‚¹ï¼Œå¹¶æŒ‰å±‚æ¬¡æ¢³ç†å¦‚ä¸‹ï¼Œä¾¿äºä½ å¿«é€Ÿè°ƒä¼˜ä¸æ’éšœã€‚

### ç¨³å®šæ€§æœºåˆ¶ï¼ˆé‡è¯•/è¶…æ—¶/ç†”æ–­/å¥åº·æ£€æŸ¥/å¹¶å‘æ§åˆ¶/ä¼šè¯éš”ç¦»/æ¢å¤ï¼‰
- ç»Ÿä¸€é‡è¯•ä¸æŒ‡æ•°é€€é¿
  - æ•°æ®åº“æ“ä½œé‡è¯•ä¸ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼š`utils/database/error_handler.py`
```1:80:utils/database/error_handler.py
"""
æ•°æ®åº“é”™è¯¯å¤„ç†å·¥å…·
æä¾›é‡è¯•æœºåˆ¶å’Œç»Ÿä¸€é”™è¯¯å¤„ç†
"""
...
    def with_retry(
        self, 
        operation: Callable, 
        max_attempts: int = 3, 
        delay: float = 1.0,
        operation_name: str = "æ•°æ®åº“æ“ä½œ"
    ) -> Any:
        ...
        for attempt in range(max_attempts):
            try:
                result = operation()
                ...
            except Exception as e:
                ...
                wait_time = delay * (2 ** attempt)  # æŒ‡æ•°é€€é¿
                ...
```
  - ä¸Šä¸‹æ–‡æ„å»ºçš„è½»é‡é‡è¯•ï¼š`utils/context_helper.py::setup_agent_context`ï¼ˆå¹¶å‘ä¸‹çš„æ•°æ®å°±ç»ªé‡è¯•ï¼‰

- è¿æ¥æ± ä¸èµ„æºç®¡ç†
  - ç»Ÿä¸€è¿æ¥æ± ä¸å¥åº·ç›‘æ§/é¢„çƒ­/è‡ªåŠ¨æ¢å¤ï¼š`utils/connection_pool_manager.py`
  - Redis å®¢æˆ·ç«¯ä¸ç®¡é“å°è£…ï¼š`utils/redis_client.py`

- å¹¶å‘ä¸èƒŒå‹
  - ç¼–æ’å±‚å¹¶å‘é—¸é—¨ï¼ˆSemaphoreï¼Œé¿å…æ± è€—å°½/æŠ–åŠ¨ï¼‰ï¼š`agents/loomi/orchestrator.py`
```21:73:agents/loomi/orchestrator.py
...
        # ğŸš€ ã€å¹¶å‘æ§åˆ¶é…ç½®ã€‘é¿å…è¿æ¥æ± è€—å°½
        self.max_concurrent_agents = 8
        self.agent_semaphore = asyncio.Semaphore(self.max_concurrent_agents)
        ...
        # â° è¾“å‡ºé—´éš”æ§åˆ¶ï¼Œé¿å…è¾“å‡ºè¿‡å¯†é€ æˆä¸‹æ¸¸å‹åŠ›
        self.output_interval = 10.0
...
```
  - å·¥å…·çº§å¹¶å‘é™é¢ï¼ˆå…¨å±€+æ¯è´¦å·åŒé˜ˆå€¼ï¼‰ï¼š`agents/graph/tool/xhs_search/concurrency_control.py`

- ä¼šè¯çº§éš”ç¦»ä¸çŠ¶æ€ä¸€è‡´æ€§
  - é¿å…å…¨å±€å•ä¾‹ä¸²è¯/çŠ¶æ€æ±¡æŸ“çš„ä¼šè¯çº§ Agent ç®¡ç†ï¼š`apis/routes.py::SessionAgentManager`

- å¥åº·æ£€æŸ¥ä¸ç›‘æ§
  - å¥åº·/å°±ç»ªæ£€æŸ¥ï¼š`apis/health.py`ã€å›¾æœåŠ¡å¥åº·ï¼š`apis/graph_routes.py::/graph/health`
  - Nginx å±‚å¥åº·è½¬å‘ä¸è¶…æ—¶è®¾ç½®ï¼š`nginx.conf`ï¼ˆä¸‹èŠ‚é™„å¸¦ï¼‰

- æŒä¹…åŒ–/æ£€æŸ¥ç‚¹ä¸æ¢å¤
  - LangGraph Redis Checkpointï¼ˆå¯æ¢å¤ä¸­æ–­ã€è®¾ç½®TTLï¼‰ï¼š`agents/graph/redis_checkpoint.py::AsyncRedisSaver`
  - ä¸‰å±‚é˜Ÿåˆ—ï¼ˆå†…å­˜â†’Redisâ†’æ–‡ä»¶ï¼‰ä½œä¸ºç¼“å†²ä¸é™çº§ï¼š`utils/layered_queue_manager.py`
  - Redis å¤±æ•ˆå›é€€æ•°æ®åº“å¹¶å›å†™ç¼“å­˜ï¼š`utils/loomi_context_manager.py`

- å…¨å±€è¶…æ—¶ä¸æ€§èƒ½å‚æ•°
  - APIã€LLMã€å¹¶å‘é˜ˆå€¼ç­‰é›†ä¸­é…ç½®ï¼š`config/app_config.yaml`

### æµé‡è¶…é™ä¸å‰ç½®é™æµï¼ˆå…¥å£/åº”ç”¨å†…/ä¸‹æ¸¸ï¼‰
- å…¥å£å±‚ï¼ˆNginxï¼‰é™æµä¸è¶…æ—¶
```1:43:nginx.conf
...
    # é™æµé…ç½®
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
...
        location / {
            limit_req zone=api_limit burst=20 nodelay;
```
  - è¶…æ—¶ï¼š`proxy_read_timeout 300s`ã€`proxy_send_timeout 300s`

- åº”ç”¨å†…ï¼ˆFastAPIä¸­é—´ä»¶ï¼‰æŒ‰ç”¨æˆ·IDé™æµ + å‘Šè­¦
```92:189:apis/app.py
...
            # APIé™æµæ£€æŸ¥ - åŸºäºç”¨æˆ·IDï¼Œä½¿ç”¨Redisé…ç½®çš„é™æµå‚æ•°
            rate_limiter = await get_rate_limiter()
            is_allowed, rate_info = await rate_limiter.is_allowed(identifier=current_user_id)
            if not is_allowed:
                # è®°å½•å¹¶å¼‚æ­¥å‘é€é™æµå‘Šè­¦
                asyncio.create_task(alert_manager.send_rate_limit_alert(...))
...
            # å“åº”å¤´é€å‡ºé…é¢ï¼Œä¾¿äºå‰ç«¯/ç½‘å…³æ„ŸçŸ¥ä¸é€€é¿
            response.headers["X-RateLimit-Limit"] = ...
```
  - é™æµç®—æ³•ï¼šRedisæ»‘åŠ¨çª—å£ï¼ŒRediså¼‚å¸¸æ—¶â€œä¼˜é›…é™çº§ä¸ºæ”¾è¡Œå¹¶è®°å½•â€ï¼š
```1:156:utils/rate_limiter.py
...
        if not redis:
            # Redisä¸å¯ç”¨æ—¶ï¼Œé»˜è®¤å…è®¸è¯·æ±‚ï¼ˆä¸é˜»å¡ä¸»é“¾è·¯ï¼‰
            return True, {..., "redis_available": False}
```

- ç¼–æ’/å·¥å…·å±‚èƒŒå‹ä¸èŠ‚æµ
  - `Semaphore` æ§å¹¶å‘ã€è¾“å‡ºèŠ‚æµï¼ˆå‡å°‘å³°å€¼æŠ–åŠ¨ï¼‰ï¼š`agents/loomi/orchestrator.py`
  - è´¦å·çº§é™å¹¶å‘ï¼Œé˜²æ­¢åŒæºä¸‹æ¸¸è¢«æ‰“çˆ†ï¼š`agents/graph/tool/xhs_search/concurrency_control.py`
  - ä¸‰å±‚é˜Ÿåˆ—åšâ€œå‰Šå³°å¡«è°·â€ï¼š`utils/layered_queue_manager.py`

- é…ç½®ä¸è°ƒä¼˜ä½ç‚¹
  - åº”ç”¨å±‚å‚æ•°ï¼š`config/app_config.yaml`
    - `security.rate_limit_per_minute`ï¼ˆé»˜è®¤3600ï¼Œå»ºè®®ç»“åˆNginxæŒ‰é‡çº§åè°ƒï¼‰
    - `performance.max_concurrent_users`ã€`max_concurrent_agents`ã€`llm_timeout`ã€`response_timeout`
  - é™æµåŠ¨æ€é…ç½®ï¼š`utils/rate_limiter.py` ä½¿ç”¨ Redis é”® `config:rate_limit`ï¼ˆæ”¯æŒåœ¨çº¿è°ƒæ•´ï¼‰
  - Nginx é™æµä¸ burstï¼š`nginx.conf`
  - è¿æ¥æ± å¤§å°ä¸è¶…æ—¶ï¼š`utils/connection_pool_manager.py::_pool_configs`
  - ç¼–æ’å¹¶å‘é˜ˆå€¼ï¼š`agents/loomi/orchestrator.py::max_concurrent_agents`

### å‘ç”Ÿâ€œæµé‡è¶…å‡º/æŠ–åŠ¨â€æ—¶çš„ç³»ç»Ÿè¡Œä¸ºï¼ˆç«¯åˆ°ç«¯ï¼‰
- å…ˆè¢« Nginx `limit_req` é™é€Ÿï¼ˆ10 r/sï¼Œburst 20ï¼‰ï¼Œè¶…å‡ºè¯·æ±‚è¢«å»¶è¿Ÿæˆ–æ‹’ç»ã€‚
- è¿›å…¥åº”ç”¨åï¼ŒFastAPI ä¸­é—´ä»¶æŒ‰ç”¨æˆ·IDäºŒæ¬¡é™æµï¼›è¶…é™ä¼šè¿”å›é…é¢ä¿¡æ¯å¤´ï¼Œä¸”å¼‚æ­¥å‘Šè­¦ã€‚
- ç¼–æ’å±‚ä¸å·¥å…·å±‚å†åšå¹¶å‘é—¸é—¨ä¸è¾“å‡ºèŠ‚æµï¼Œä¿æŠ¤è¿æ¥æ± ä¸ä¸‹æ¸¸æœåŠ¡ã€‚
- Redis å¼‚å¸¸æ—¶é™æµå™¨é™çº§æ”¾è¡Œä½†è®°å½•çŠ¶æ€ï¼Œä¸šåŠ¡ä¸ä¸­æ–­ï¼›ä¸Šä¸‹æ–‡/é˜Ÿåˆ—ä¹Ÿæœ‰ DB/æ–‡ä»¶å›é€€ã€‚
- å‘ç”Ÿæ•…éšœæˆ–è¶…æ—¶ï¼Œæ•°æ®åº“/ä¸Šä¸‹æ–‡è®¿é—®ç”±é‡è¯•+æŒ‡æ•°é€€é¿å…œåº•ï¼Œé•¿é“¾è·¯ç”±å¥åº·æ£€æŸ¥ä¸å‘Šè­¦ä¿ƒè¿›è‡ªæ„ˆã€‚

### ä½ å¯ä»¥ç›´æ¥è°ƒæ•´çš„å…³é”®ç‚¹
- å…¥å£é™æµï¼š`nginx.conf` çš„ `rate`ã€`burst`
- åº”ç”¨é™æµï¼š`config/app_config.yaml` ä¸ Redis `config:rate_limit`ï¼Œä»¥åŠä¸­é—´ä»¶é€»è¾‘
- å¹¶å‘/èƒŒå‹ï¼š`agents/loomi/orchestrator.py` çš„ `max_concurrent_agents` ä¸è¾“å‡ºé—´éš”
- è¿æ¥æ± ï¼š`utils/connection_pool_manager.py` çš„å„ pool é…ç½®
- è¶…æ—¶ï¼š`config/app_config.yaml::performance.*` ä¸ Nginx `proxy_*_timeout`

æˆ‘å·²ç»æ¢³ç†å‡ºä»¥ä¸Šæ‰€æœ‰ä½ç½®ï¼Œè‹¥ä½ è¦æˆ‘æŒ‰ä½ çš„ç¯å¢ƒâ€œä¿å®ˆ/æ¿€è¿›/æ··åˆâ€ç­–ç•¥å‡ºä¸€å¥—å…·ä½“è°ƒå‚æ¸…å•å’Œå˜æ›´å»ºè®®ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™å‡ºå…·ä½“æ•°å€¼ä¸å¯¹åº”ç¼–è¾‘ç‚¹å¹¶ä¸€æ¬¡æ€§æ”¹å¥½ã€‚

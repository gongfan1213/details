我先全局搜一下项目里与稳定性（重试、超时、熔断、健康检查、并发控制）以及流量控制（限流、队列、背压、降级）相关的实现位置，然后再给你针对本项目的概览说明和关键文件位置。

[5 tools called]

我已经定位到本项目里“稳定性保障”和“流量超限（溢出）应对”的核心实现点，并按层次梳理如下，便于你快速调优与排障。

### 稳定性机制（重试/超时/熔断/健康检查/并发控制/会话隔离/恢复）
- 统一重试与指数退避
  - 数据库操作重试与统一错误处理：`utils/database/error_handler.py`
```1:80:utils/database/error_handler.py
"""
数据库错误处理工具
提供重试机制和统一错误处理
"""
...
    def with_retry(
        self, 
        operation: Callable, 
        max_attempts: int = 3, 
        delay: float = 1.0,
        operation_name: str = "数据库操作"
    ) -> Any:
        ...
        for attempt in range(max_attempts):
            try:
                result = operation()
                ...
            except Exception as e:
                ...
                wait_time = delay * (2 ** attempt)  # 指数退避
                ...
```
  - 上下文构建的轻量重试：`utils/context_helper.py::setup_agent_context`（并发下的数据就绪重试）

- 连接池与资源管理
  - 统一连接池与健康监控/预热/自动恢复：`utils/connection_pool_manager.py`
  - Redis 客户端与管道封装：`utils/redis_client.py`

- 并发与背压
  - 编排层并发闸门（Semaphore，避免池耗尽/抖动）：`agents/loomi/orchestrator.py`
```21:73:agents/loomi/orchestrator.py
...
        # 🚀 【并发控制配置】避免连接池耗尽
        self.max_concurrent_agents = 8
        self.agent_semaphore = asyncio.Semaphore(self.max_concurrent_agents)
        ...
        # ⏰ 输出间隔控制，避免输出过密造成下游压力
        self.output_interval = 10.0
...
```
  - 工具级并发限额（全局+每账号双阈值）：`agents/graph/tool/xhs_search/concurrency_control.py`

- 会话级隔离与状态一致性
  - 避免全局单例串话/状态污染的会话级 Agent 管理：`apis/routes.py::SessionAgentManager`

- 健康检查与监控
  - 健康/就绪检查：`apis/health.py`、图服务健康：`apis/graph_routes.py::/graph/health`
  - Nginx 层健康转发与超时设置：`nginx.conf`（下节附带）

- 持久化/检查点与恢复
  - LangGraph Redis Checkpoint（可恢复中断、设置TTL）：`agents/graph/redis_checkpoint.py::AsyncRedisSaver`
  - 三层队列（内存→Redis→文件）作为缓冲与降级：`utils/layered_queue_manager.py`
  - Redis 失效回退数据库并回写缓存：`utils/loomi_context_manager.py`

- 全局超时与性能参数
  - API、LLM、并发阈值等集中配置：`config/app_config.yaml`

### 流量超限与前置限流（入口/应用内/下游）
- 入口层（Nginx）限流与超时
```1:43:nginx.conf
...
    # 限流配置
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
...
        location / {
            limit_req zone=api_limit burst=20 nodelay;
```
  - 超时：`proxy_read_timeout 300s`、`proxy_send_timeout 300s`

- 应用内（FastAPI中间件）按用户ID限流 + 告警
```92:189:apis/app.py
...
            # API限流检查 - 基于用户ID，使用Redis配置的限流参数
            rate_limiter = await get_rate_limiter()
            is_allowed, rate_info = await rate_limiter.is_allowed(identifier=current_user_id)
            if not is_allowed:
                # 记录并异步发送限流告警
                asyncio.create_task(alert_manager.send_rate_limit_alert(...))
...
            # 响应头透出配额，便于前端/网关感知与退避
            response.headers["X-RateLimit-Limit"] = ...
```
  - 限流算法：Redis滑动窗口，Redis异常时“优雅降级为放行并记录”：
```1:156:utils/rate_limiter.py
...
        if not redis:
            # Redis不可用时，默认允许请求（不阻塞主链路）
            return True, {..., "redis_available": False}
```

- 编排/工具层背压与节流
  - `Semaphore` 控并发、输出节流（减少峰值抖动）：`agents/loomi/orchestrator.py`
  - 账号级限并发，防止同源下游被打爆：`agents/graph/tool/xhs_search/concurrency_control.py`
  - 三层队列做“削峰填谷”：`utils/layered_queue_manager.py`

- 配置与调优位点
  - 应用层参数：`config/app_config.yaml`
    - `security.rate_limit_per_minute`（默认3600，建议结合Nginx按量级协调）
    - `performance.max_concurrent_users`、`max_concurrent_agents`、`llm_timeout`、`response_timeout`
  - 限流动态配置：`utils/rate_limiter.py` 使用 Redis 键 `config:rate_limit`（支持在线调整）
  - Nginx 限流与 burst：`nginx.conf`
  - 连接池大小与超时：`utils/connection_pool_manager.py::_pool_configs`
  - 编排并发阈值：`agents/loomi/orchestrator.py::max_concurrent_agents`

### 发生“流量超出/抖动”时的系统行为（端到端）
- 先被 Nginx `limit_req` 限速（10 r/s，burst 20），超出请求被延迟或拒绝。
- 进入应用后，FastAPI 中间件按用户ID二次限流；超限会返回配额信息头，且异步告警。
- 编排层与工具层再做并发闸门与输出节流，保护连接池与下游服务。
- Redis 异常时限流器降级放行但记录状态，业务不中断；上下文/队列也有 DB/文件回退。
- 发生故障或超时，数据库/上下文访问由重试+指数退避兜底，长链路由健康检查与告警促进自愈。

### 你可以直接调整的关键点
- 入口限流：`nginx.conf` 的 `rate`、`burst`
- 应用限流：`config/app_config.yaml` 与 Redis `config:rate_limit`，以及中间件逻辑
- 并发/背压：`agents/loomi/orchestrator.py` 的 `max_concurrent_agents` 与输出间隔
- 连接池：`utils/connection_pool_manager.py` 的各 pool 配置
- 超时：`config/app_config.yaml::performance.*` 与 Nginx `proxy_*_timeout`

我已经梳理出以上所有位置，若你要我按你的环境“保守/激进/混合”策略出一套具体调参清单和变更建议，我可以直接给出具体数值与对应编辑点并一次性改好。

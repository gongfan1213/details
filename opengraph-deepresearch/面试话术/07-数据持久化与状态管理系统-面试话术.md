# 数据持久化与状态管理系统｜技术面试话术

## 一句话定位
- 面向会话/消息/流程事件的多后端持久化：Redis（热数据）+ 文件/DB（冷数据）。

## 架构要点
- 存储层：`utils/database/*`（context/stream/user/notes），统一接口。
- 队列与缓存：`utils/layered_queue_manager.py` 三层（内存/Redis/文件）命中回退。
- 会话与对话：Session/Conversation/StreamEvent 三类结构化表。

## 难点与解决
- 写后读一致性：写后强制刷新或版本推进；热点键加租约避免并发覆盖。
- 回放与审计：事件追加写，带序号；重放有界限，防止二次副作用。
- 迁移与备份：周期快照；向后兼容serde版本。

## 指标与收益
- 命中率与回放成功率提升；冷启动时延下降。

## 可扩展 & 高可用
- 存储后端可替换（S3/PG/SQLite）；关键表添加二级索引与TTL。

## Demo 话术
- 展示“断线后重连”：先回放历史事件，再切换实时SSE。

## 追问与答法
- Q：如何避免重复消费？
  - A：基于会话+序号的去重窗口；事件幂等键。

### 15 可扩展性与韧性手册面试题（Scalability & Resilience Playbook）

- 关注点：横向扩展、流控与退避、熔断与降级、连接池与资源隔离、恢复演练
- 关键参考：`utils/aioredis_fix.py`, `utils/rate_limiter.py`, `utils/connection_pool_manager.py`, `config/performance_optimization.py`

#### 基础题
- 横向扩展：无状态 API + 共享 Checkpoint 如何实现多副本并行处理？
- 连接池：数据库/向量库/HTTP 客户端的池化与上限设置原则？
- Python 3.13 与 aioredis：为什么需要 `aioredis_fix.py`，其工作原理是什么？

#### 进阶题
- 流控：全局/租户/用户三级限流与配额；工具级并发控制（参考 XHS）。
- 退避与熔断：指数退避 + 抖动、错误分级、隔离舱；触发与恢复阈值如何设定？
- 降级矩阵：按功能模块提供静态兜底/近似结果/延迟执行等策略。

#### 实操题
- 为最慢的外部依赖制定“保护策略”：速率限制、舱壁隔离、熔断、回退链、观察指标。
- 演练：设计“Redis 不可用”与“Milvus 变慢”的演练剧本与验证标准。

#### 场景题
- 大促流量：如何进行压测、预热、弹性扩容、降级开关联动？
- 灾难恢复：跨可用区部署、数据备份与恢复点目标（RPO/RTO）。

#### 追问
- 事件后回溯：如何通过结构化日志 + trace/span 还原事发链路？
- 成本守恒：扩容与限流如何平衡“成功率 vs 成本”？

#### 作业
- 画出“韧性策略决策树”：输入为错误类型/频率/延迟分布，输出为重试/熔断/降级/告警组合。

#### 图稿
- 参见：`interview/diagrams/scalability_resilience.md`。

### 参考答案（示例）
- 横向扩展：无状态 API + 共享 Redis/Milvus + 检查点恢复；连接池与速率限制防止打满下游；
- 舱壁隔离：按租户/业务线隔离线程池/队列，避免级联；
- 退避/熔断/降级：指数退避 + 抖动，错误分级熔断并返回降级结果（静态/延迟/近似），设置恢复窗口；
- 观测与演练：对关键依赖设“金指标”SLO（可用性/时延/错误），按月演练“Redis 不可用/Milvus 变慢/外部 API 限流”。

#### 配置示例（速率/超时/连接池）
```yaml
rate_limits:
  global_rps: 300
  tenant:
    default_rps: 50
timeouts:
  http:
    connect_ms: 800
    read_ms: 3000
pools:
  redis:
    max_connections: 200
  milvus:
    max_connections: 64
```

#### 熔断规则（示意）
- 连续错误率 > 20% 且 1 分钟内请求数 > 100 → 进入 open 状态 60 秒；
- 半开期间放行 10% 探测流量，若成功率 > 90% 则恢复；
- open 状态下返回降级结果（静态/延迟/近似）。

### 常见错误与改进建议
- 错误：无限重试与无上限并发，放大故障。
  - 改进：指数退避 + 最大时长 + 限流；对错误分级熔断与降级返回。
- 错误：连接池默认配置，遭遇峰值即崩。
  - 改进：为 Redis/Milvus/HTTP 自定义连接池与超时，并按环境调参。

我先在代码库里并行搜索数据库/存储相关的实现位置（配置、ORM/SQL、Redis、Supabase等），再汇总数据库表与接口。

[5 tools called]

我先快速定位具体的表结构与存储客户端实现文件，以及API路由定义，随后提炼表字段与接口入参/出参。

[5 tools called]

我将并行读取存储服务与API路由/数据模型文件，梳理表字段及接口入参/出参。

[6 tools called]

我将并行打开 API 路由文件以提取接口定义与入参/出参。

[5 tools called]

我已定位到数据库迁移脚本与持久化服务代码，并梳理了所有主要 API 路由；下面给出表结构与接口清单的精简解析。

### 数据库表设计（PostgreSQL on Supabase，启用RLS）
- 注意
  - 所有业务表均启用 RLS，普通用户按 `auth.uid()` 仅能访问自己的数据；后端使用 `service_role` 客户端读写（绕过RLS）。
  - 广泛使用索引（复合、JSONB、全文），时间戳 `created_at/updated_at` 配合触发器自动更新。
  - 连接通过 `utils/database/client.py` 单例管理；持久化统一入口 `utils/database/persistence_manager.py`。

- contexts（用户会话上下文）
  - 关键字段: `id uuid PK`, `user_id text`, `session_id text`, `action text`, `context_data jsonb`, `metadata jsonb`, `created_at`, `updated_at`
  - 约束/索引: `(user_id, session_id)` 唯一；BTree：`(user_id, session_id)`, `action`, `created_at` 等；GIN：`context_data`
  - 用途: 存储按 Agent 类型划分的上下文快照（如 concierge/orchestrator 等）

- notes（AI 分析结果/中间产物）
  - 关键字段: `id uuid PK`, `user_id`, `session_id`, `action`, `name`, `title`, `context text`, `select_status int(0/1)`, `metadata jsonb`, `created_at`, `updated_at`
  - 约束/索引: `(user_id, session_id, name)` 唯一；多列 BTree；全文索引：`to_tsvector('simple', context)`；GIN：`metadata`
  - 用途: 存放画像、洞察、痛点等命名型 Note，并支持选择状态

- loomi_stream_events（流式事件/断网恢复）
  - 关键字段: `id bigserial PK`, `session_id`, `user_id`, `event_type`, `content_type`, `agent_source`, `event_data jsonb`, `event_metadata jsonb`, `created_at`, `is_replayed bool`, `user_last_seen timestamptz`, `is_after_disconnect bool`, `is_session_complete bool`, `task_phase text`
  - 索引: `(session_id, created_at)`, `(session_id, is_replayed, is_after_disconnect)`, 多列 BTree，GIN：`event_data`, `event_metadata`
  - 用途: 存储SSE事件流及回放状态、用户心跳时间、断网后事件标记、会话完成标记

- uploaded_files（文件上传/解析）
  - 关键字段: `id uuid PK`, `file_id text UNIQUE`, `user_id`, `session_id`, `original_filename`, `file_type`, `file_size`, `mime_type`, `description`, `upload_mode in ('ai_parse','storage_only')`, `oss_url`, `oss_object_name`, `oss_bucket_name`, `gemini_file_uri`, `gemini_file_name`, `processing_status`, `metadata jsonb`, `created_at`, `updated_at`
  - 索引: 常见查询字段及 `file_id`、`created_at`
  - 用途: 统一记录 OSS 与 Gemini 文件信息，支持AI解析/仅存储两种模式

- Supabase `auth.users`（外部）
  - 通过 RPC 或 `auth` schema 只读查询（见 `user_storage.py`）

### 持久化服务层（应用内 API）
- `ContextStorage`（`utils/database/context_storage.py`）
  - 能力: 保存/加载/删除上下文，加载会话所有上下文，`jsonb_set` 局部字段更新（经 RPC 执行 SQL）
- `NotesStorage`（`utils/database/notes_storage.py`）
  - 能力: upsert 创建/更新、按 name 获取、按会话/类型/选择状态筛选、选择状态更新/批量更新、删除
- `StreamEventStorageSimple`（`utils/database/stream_storage_simple.py`）
  - 能力: 心跳记录（缓存+DB）、存储事件（初始 `is_replayed=False`）、回放判定（心跳时间窗口+未回放事件）、精准/全部标记已回放、实时/混合模式拉流、完成状态检测（`is_session_complete`/最近活动）
- `UserStorage`（`utils/database/user_storage.py`）
  - 能力: 通过 RPC 查询用户、存在性、邮箱、统计（某日新增、留存）、汇总

### 关键后端接口（FastAPI）
- 根应用与中间件
  - 文件: `apis/app.py`
  - 鉴权: 路由白名单中的接口会校验 Supabase Token，并做用户级限流（Redis 配置）
  - 启动: 调用 `startup_persistence()` 初始化持久化层

- LangGraph 多智能体（v1）
  - 文件: `apis/graph_routes.py`，前缀 `/graph`
  - POST `/graph/chat`
    - 入参: `{user_id, session_id, query, file_ids?, enable_human_review?}`
    - 能力: 同步执行三阶段流程（alignment/research/writing），返回聚合状态与结果
  - POST `/graph/chat/stream`
    - SSE 流式输出节点与阶段进度、最终结果
  - POST `/graph/resume`
    - 入参: `{user_id, session_id, approved, feedback?, action?, additional_instructions?}`
    - 能力: 人工审核后通过 LangGraph Command 恢复中断
  - POST `/graph/status`
    - 返回当前线程状态、是否存在 checkpoint、阶段完成情况
  - GET `/graph/health`
    - 编译健康、使用的 checkpoint 类型（memory/redis）
  - POST `/graph/test/simple`
    - 内置流程简单测试

- LangGraph 内容创作（v2）
  - 文件: `apis/graph_routes_v2.py`，前缀 `/graph_v2`
  - POST `/graph_v2/chat/stream`
    - 与上类似，但图构建为内容创作专用；支持从已有 state 追加消息历史

- 断网恢复/混合流
  - 文件: `apis/recovery_routes_simple.py`，前缀 `/api/loomi`
  - POST `/api/loomi/heartbeat`
    - 入参: `{user_id, session_id}`；写入心跳（每5秒）
  - GET `/api/loomi/stream/{user_id}/{session_id}`
    - 智能判断：无需回放/纯回放/回放+实时混合/纯实时流；流结束会发送 `[DONE]`
  - GET `/api/loomi/debug/status/{session_id}`
    - 返回回放判定信息
  - GET `/api/loomi/debug/disconnect/{session_id}`
    - 返回断网后事件诊断
  - GET `/api/loomi/debug/completion/{session_id}`
    - 返回会话完成状态诊断与任务状态

### 端到端数据流要点
- API 收到请求 → 校验 token 与限流 → LangGraph 执行或恢复 → 事件流写入 `loomi_stream_events` → SSE 返回；持久化层按需更新 `contexts`、`notes`。
- 断网/重连时，前端先 POST 心跳，后 GET 智能流接口，后端基于未回放事件与心跳窗口精确回放，并切换实时拉流；发送过的事件立即标记 `is_replayed=true`，避免重复。

### 推荐查询/使用示例（简要）
- 查询会话上下文：按 `(user_id, session_id)` 并可按 `action` 过滤；深度字段用 `jsonb_set`。
- Notes 去重：按 `(user_id, session_id, name)` upsert。
- 事件回放窗口：以最近 `user_last_seen + 30s` 起始筛选 `is_replayed=false` 事件。

以上即该项目数据库与接口的核心设计脉络。若需要，我可以输出 Swagger 级别的参数说明表或为这些表生成 ER 图。

# 工作流管理功能

## 1. 功能概述

工作流管理是PMHub系统的重要业务模块，基于Flowable工作流引擎构建，提供完整的业务流程管理功能。该模块支持流程设计、流程部署、流程执行、任务处理等核心功能，实现企业业务流程的自动化和规范化管理。

## 2. 技术架构

### 2.1 模块架构

```
工作流架构:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面       │    │   工作流服务     │    │   Flowable引擎   │
│                 │    │                 │    │                 │
│ - 流程设计器     │    │ - 流程管理      │    │ - 流程定义      │
│ - 流程监控       │    │ - 任务管理      │    │ - 流程实例      │
│ - 任务处理       │    │ - 表单管理      │    │ - 任务执行      │
│ - 流程统计       │    │ - 部署管理      │    │ - 历史记录      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 技术选型

- **工作流引擎**: Flowable 6.7.2
- **后端框架**: Spring Boot + MyBatis-Plus
- **数据库**: MySQL 8.0
- **前端框架**: Vue 2.6 + Element UI
- **流程设计器**: BPMN.js 7.5.0
- **消息队列**: RocketMQ

## 3. 核心功能模块

### 3.1 流程设计管理

#### 3.1.1 流程模型管理

**功能描述**: 支持流程模型的创建、编辑、保存和版本管理。

**核心功能**:
- 流程模型创建
- 流程设计编辑
- 模型版本管理
- 模型导入导出
- 模型分类管理

**数据模型**:
```sql
-- 流程模型表
CREATE TABLE wf_model (
    model_id BIGINT PRIMARY KEY,
    model_key VARCHAR(64) NOT NULL COMMENT '模型标识',
    model_name VARCHAR(255) NOT NULL COMMENT '模型名称',
    model_category VARCHAR(64) COMMENT '模型分类',
    model_version INT DEFAULT 1 COMMENT '模型版本',
    model_description TEXT COMMENT '模型描述',
    model_xml LONGTEXT COMMENT '模型XML内容',
    create_time DATETIME,
    create_by VARCHAR(64)
);
```

### 3.2 流程部署管理

#### 3.2.1 流程部署

**功能描述**: 支持流程定义的部署、版本管理和部署历史。

**核心功能**:
- 流程定义部署
- 版本管理
- 部署历史
- 流程激活/挂起
- 流程删除

**部署服务**:
```java
@Service
public class WfDeployService {
    
    public void deployProcess(String deployName, String deployKey, String xmlContent) {
        try {
            // 部署流程定义
            Deployment deployment = repositoryService.createDeployment()
                .name(deployName)
                .key(deployKey)
                .addString(deployKey + ".bpmn20.xml", xmlContent)
                .deploy();
            
            // 记录部署信息
            WfDeploy wfDeploy = new WfDeploy();
            wfDeploy.setDeployName(deployName);
            wfDeploy.setDeployKey(deployKey);
            wfDeploy.setDeployTime(new Date());
            wfDeploy.setDeployUserId(SecurityUtils.getUserId());
            
            wfDeployMapper.insert(wfDeploy);
            
        } catch (Exception e) {
            throw new BusinessException("流程部署失败：" + e.getMessage());
        }
    }
}
```

### 3.3 流程实例管理

#### 3.3.1 流程启动

**功能描述**: 支持流程实例的启动、管理和监控。

**核心功能**:
- 流程实例启动
- 实例状态管理
- 实例监控
- 实例终止
- 实例历史

**启动服务**:
```java
@Service
public class WfProcessService {
    
    public ProcessInstance startProcess(String processDefinitionKey, String businessKey, Map<String, Object> variables) {
        try {
            // 启动流程实例
            ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(
                processDefinitionKey,
                businessKey,
                variables
            );
            
            // 记录流程实例信息
            WfInstance wfInstance = new WfInstance();
            wfInstance.setProcessInstanceId(processInstance.getId());
            wfInstance.setProcessDefinitionKey(processDefinitionKey);
            wfInstance.setBusinessKey(businessKey);
            wfInstance.setStartUserId(SecurityUtils.getUserId());
            wfInstance.setStartTime(new Date());
            wfInstance.setStatus("RUNNING");
            
            wfInstanceMapper.insert(wfInstance);
            
            return processInstance;
            
        } catch (Exception e) {
            throw new BusinessException("流程启动失败：" + e.getMessage());
        }
    }
}
```

### 3.4 任务管理

#### 3.4.1 任务处理

**功能描述**: 支持用户任务的查看、处理、转办和委托。

**核心功能**:
- 待办任务查询
- 任务处理
- 任务转办
- 任务委托
- 任务评论

**任务服务**:
```java
@Service
public class WfTaskService {
    
    public List<WfTaskVO> getTodoTasks(String userId) {
        List<Task> tasks = taskService.createTaskQuery()
            .taskAssignee(userId)
            .active()
            .orderByTaskCreateTime()
            .desc()
            .list();
        
        return tasks.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
    }
    
    public void claimTask(String taskId, String userId) {
        taskService.claim(taskId, userId);
        
        // 记录任务认领
        WfTask wfTask = wfTaskMapper.selectByTaskId(taskId);
        if (wfTask != null) {
            wfTask.setAssigneeId(Long.valueOf(userId));
            wfTask.setClaimTime(new Date());
            wfTaskMapper.updateById(wfTask);
        }
    }
    
    public void completeTask(String taskId, Map<String, Object> variables) {
        taskService.complete(taskId, variables);
        
        // 记录任务完成
        WfTask wfTask = wfTaskMapper.selectByTaskId(taskId);
        if (wfTask != null) {
            wfTask.setEndTime(new Date());
            wfTask.setDuration(System.currentTimeMillis() - wfTask.getCreateTime().getTime());
            wfTaskMapper.updateById(wfTask);
        }
    }
}
```

### 3.5 表单管理

#### 3.5.1 表单设计

**功能描述**: 支持动态表单的设计、配置和管理。

**核心功能**:
- 表单设计器
- 表单字段配置
- 表单验证规则
- 表单权限控制
- 表单版本管理

**数据模型**:
```sql
-- 工作流表单表
CREATE TABLE wf_form (
    form_id BIGINT PRIMARY KEY,
    form_key VARCHAR(64) NOT NULL COMMENT '表单标识',
    form_name VARCHAR(255) NOT NULL COMMENT '表单名称',
    form_category VARCHAR(64) COMMENT '表单分类',
    form_version INT DEFAULT 1 COMMENT '表单版本',
    form_description TEXT COMMENT '表单描述',
    form_content LONGTEXT COMMENT '表单内容(JSON)',
    form_config LONGTEXT COMMENT '表单配置(JSON)',
    form_status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT '表单状态',
    create_time DATETIME,
    create_by VARCHAR(64)
);
```

## 4. 前端界面设计

### 4.1 流程设计器

**功能特点**:
- 可视化流程设计
- 拖拽式节点配置
- 表单关联配置
- 条件分支设置
- 多实例配置

**Vue组件结构**:
```vue
<template>
  <div class="process-designer">
    <div class="toolbar">
      <el-button @click="saveModel">保存</el-button>
      <el-button @click="deployModel">部署</el-button>
      <el-button @click="previewModel">预览</el-button>
    </div>
    
    <div class="designer-container">
      <div class="palette">
        <!-- 节点类型面板 -->
        <div class="palette-item" v-for="item in paletteItems" :key="item.type"
             @mousedown="onPaletteItemMouseDown($event, item)">
          <i :class="item.icon"></i>
          <span>{{ item.label }}</span>
        </div>
      </div>
      
      <div class="canvas" ref="canvas">
        <!-- BPMN.js 画布 -->
      </div>
      
      <div class="properties-panel" v-if="selectedElement">
        <!-- 属性配置面板 -->
        <el-form :model="elementProperties" label-width="100px">
          <el-form-item label="节点名称">
            <el-input v-model="elementProperties.name" />
          </el-form-item>
          <el-form-item label="节点类型">
            <el-select v-model="elementProperties.type">
              <el-option label="用户任务" value="userTask" />
              <el-option label="服务任务" value="serviceTask" />
              <el-option label="网关" value="gateway" />
            </el-select>
          </el-form-item>
        </el-form>
      </div>
    </div>
  </div>
</template>
```

### 4.2 任务处理界面

**任务列表**:
```vue
<template>
  <div class="task-management">
    <el-tabs v-model="activeTab" @tab-click="handleTabClick">
      <el-tab-pane label="待办任务" name="todo">
        <el-table :data="todoTasks" style="width: 100%">
          <el-table-column prop="taskName" label="任务名称" />
          <el-table-column prop="processDefinitionKey" label="流程定义" width="150" />
          <el-table-column prop="businessKey" label="业务键" width="150" />
          <el-table-column prop="createTime" label="创建时间" width="180" />
          <el-table-column prop="dueDate" label="到期时间" width="180" />
          <el-table-column label="操作" width="200">
            <template slot-scope="scope">
              <el-button size="mini" @click="handleTask(scope.row)">处理</el-button>
              <el-button size="mini" @click="delegateTask(scope.row)">委托</el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-tab-pane>
      
      <el-tab-pane label="已办任务" name="done">
        <el-table :data="doneTasks" style="width: 100%">
          <el-table-column prop="taskName" label="任务名称" />
          <el-table-column prop="processDefinitionKey" label="流程定义" width="150" />
          <el-table-column prop="businessKey" label="业务键" width="150" />
          <el-table-column prop="endTime" label="完成时间" width="180" />
          <el-table-column prop="duration" label="耗时" width="120" />
          <el-table-column label="操作" width="100">
            <template slot-scope="scope">
              <el-button size="mini" @click="viewTask(scope.row)">查看</el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-tab-pane>
    </el-tabs>
  </div>
</template>
```

## 5. 集成功能

### 5.1 与项目管理集成

**项目审批流程**:
```java
@Service
public class ProjectWorkflowService {
    
    public void startProjectApproval(Project project) {
        Map<String, Object> variables = new HashMap<>();
        variables.put("projectId", project.getProjectId());
        variables.put("projectName", project.getProjectName());
        variables.put("projectManager", project.getProjectManagerId());
        variables.put("department", project.getDepartmentId());
        
        // 启动项目审批流程
        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(
            "project_approval",
            project.getProjectId().toString(),
            variables
        );
        
        // 更新项目状态
        project.setProjectStatus("PENDING_APPROVAL");
        projectService.updateProject(project);
    }
}
```

### 5.2 消息通知集成

**任务通知**:
```java
@Service
public class WfNotificationService {
    
    public void sendTaskNotification(String taskId, String type) {
        Task task = taskService.createTaskQuery()
            .taskId(taskId)
            .singleResult();
        
        if (task == null) {
            return;
        }
        
        NotificationMessage message = NotificationMessage.builder()
            .type(type)
            .title("工作流任务通知")
            .content(String.format("您有新的任务需要处理：%s", task.getName()))
            .recipientId(task.getAssignee())
            .taskId(taskId)
            .build();
        
        notificationService.sendMessage(message);
    }
}
```

## 6. 性能优化

### 6.1 数据库优化

**索引设计**:
```sql
-- 流程实例表索引
CREATE INDEX idx_process_instance_status ON wf_instance(status);
CREATE INDEX idx_process_instance_start_time ON wf_instance(start_time);
CREATE INDEX idx_process_instance_business_key ON wf_instance(business_key);

-- 任务表索引
CREATE INDEX idx_task_assignee ON wf_task(assignee_id);
CREATE INDEX idx_task_process_instance ON wf_task(process_instance_id);
CREATE INDEX idx_task_create_time ON wf_task(create_time);
CREATE INDEX idx_task_due_date ON wf_task(due_date);
```

### 6.2 缓存策略

**流程缓存**:
```java
@Service
public class WfCacheService {
    
    @Cacheable(value = "process_definition", key = "#processDefinitionKey")
    public ProcessDefinition getProcessDefinition(String processDefinitionKey) {
        return repositoryService.createProcessDefinitionQuery()
            .processDefinitionKey(processDefinitionKey)
            .latestVersion()
            .singleResult();
    }
    
    @Cacheable(value = "task", key = "#taskId")
    public Task getTask(String taskId) {
        return taskService.createTaskQuery()
            .taskId(taskId)
            .singleResult();
    }
}
```

## 7. 监控与统计

### 7.1 流程统计

**统计指标**:
- 流程实例数量统计
- 任务完成情况统计
- 流程耗时分析
- 用户工作量统计

**统计服务**:
```java
@Service
public class WfStatisticsService {
    
    public WfStatisticsVO getWorkflowStatistics() {
        WfStatisticsVO statistics = new WfStatisticsVO();
        
        // 流程实例统计
        long runningInstances = runtimeService.createProcessInstanceQuery()
            .active()
            .count();
        statistics.setRunningInstances(runningInstances);
        
        long completedInstances = historyService.createHistoricProcessInstanceQuery()
            .finished()
            .count();
        statistics.setCompletedInstances(completedInstances);
        
        // 任务统计
        long todoTasks = taskService.createTaskQuery()
            .active()
            .count();
        statistics.setTodoTasks(todoTasks);
        
        return statistics;
    }
}
```

## 8. 总结

工作流管理功能模块是PMHub系统的重要业务模块，具备以下特点：

1. **功能完整**: 涵盖流程设计、部署、执行、监控全生命周期
2. **技术先进**: 基于Flowable工作流引擎，技术成熟稳定
3. **操作便捷**: 可视化流程设计器，拖拽式操作
4. **扩展性强**: 支持自定义表单、条件分支、多实例等高级功能
5. **集成性好**: 与项目管理、消息通知等模块深度集成
6. **监控完善**: 提供完整的流程监控和统计分析功能

该模块为企业提供了强大的业务流程管理能力，帮助企业实现业务流程的自动化和规范化管理。

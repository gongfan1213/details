# 网关与微服务治理

## 1. 概述

网关模块（`pmhub-gateway`）是系统入口，负责统一鉴权、路由转发、灰度发布、限流熔断、统一日志与指标采集；配合 Nacos、Sentinel 构成微服务治理的核心基座。

## 2. 路由与注册发现

- 服务发现：Nacos 注册每个微服务实例
- 动态路由：基于服务名的路由规则，支持前缀剥离、重写
- 健康探测：失联实例自动剔除

## 3. 统一鉴权

- JWT 透传：从 Header 解析 `Authorization: Bearer xxx`
- 黑白名单：登录/验证码等匿名放行，其余必须携带 Token
- 权限前置：可在网关层做 URI 与 `perms` 对应的快速校验（可选）

## 4. 限流与熔断

- Sentinel 网关规则：按路由/URI/IP/用户维度限流
- 熔断降级：下游异常时快速熔断，返回友好错误
- 自定义返回：统一 JSON 错误体 `{code,msg}`

## 5. 全局过滤器链

- 访问日志：记录 traceId、用户、URI、耗时
- 请求增强：透传用户信息、部门、角色、客户端信息
- 跨域处理：统一 CORS 策略
- 防重放/幂等：Header 签名 + 短期令牌（可选）

## 6. 微服务治理

- 配置管理：Nacos Config 管理各服务 `*-dev.yml`
- 流量治理：权重路由、灰度发布（按用户/版本标签）
- 超时重试：OpenFeign 超时 + 重试策略
- 链路追踪：SkyWalking/traceId 贯穿

## 7. 性能与可用性

- 无状态扩容：网关多副本 + Nginx/LB 负载
- 连接池调优：HTTPClient/Netty 参数
- 缓存：热门配置与鉴权信息本地缓存

## 8. 常见问题

- 401/403：检查白名单与 Token 过期；确认时间同步
- 404：确认路由断言与下游服务是否注册
- 限流误伤：检查 Sentinel 规则维度与阈值

## 9. 扩展

- API 网关聚合：聚合多个后端接口为单一接口
- 协议支持：WebSocket 透传、SSE 支持
- 安全增强：WAF/SQL/XSS 规则联动

# 面试话术｜认证与权限（Spring Security + JWT + RBAC）

## 1. 我做了什么（30s 概述）
- 负责设计与落地统一认证与权限体系：登录鉴权（JWT）、RBAC 菜单/按钮权限、数据权限（按部门/本人/自定义）、在线会话与风控（IP/UA）。
- 接入网关前置校验、后端细粒度注解拦截，支撑多模块一致的安全策略。

## 2. 核心能力与技术选型
- 认证：Spring Security + JWT 无状态会话，Token 存于 Header，支持刷新与踢出登录。
- 授权：RBAC + 细粒度 `@RequiresPermissions`，按钮/接口两级校验；数据权限注解 `@DataScope` 动态拼接。
- 会话：Redis 存储 `login_tokens:*`，支持多端并行与主动失效。
- 网关：鉴权白名单、黑名单、跨域、限流。异常统一 JSON 返回。

## 3. 遇到的问题（难点）
1) Token 过期与续期体验差：频繁 401 影响关键流程。
2) 数据权限规则复杂：同一接口需兼容“本人/本部门/本部门及以下/自定义部门”。
3) 权限缓存与菜单动态变化：角色或菜单调整后权限不即时生效。
4) 网关鉴权与服务鉴权重复：性能与一致性权衡。

## 4. 我的解决方案与取舍
- Token 续期：
  - 方案：前端在 Token 剩余有效期阈值内静默刷新；后端 `TokenService.refreshToken()` 滑动过期。
  - 取舍：不做强制刷新接口，避免并发“刷新风暴”，以滑动过期为主，前端兜底一次刷新。
- 数据权限：
  - 方案：`@DataScope` + AOP 注入 where 片段，内置四类策略；对大 SQL 场景提供“以部门ID集合换行内联”的可配置策略。
  - 取舍：可读性 vs 可维护性，统一走 Mapper 层参数，避免业务层拼接。
- 权限缓存失效：
  - 方案：角色/菜单变更后发布缓存失效事件（MQ 或本地事件），清理 `permissions:*` 并通知在线用户刷新权限。
  - 取舍：优先一致性，允许极短时间窗口的旧权限生效。
- 鉴权位置：
  - 方案：网关只做认证（Token 合法性/黑白名单），授权下沉到服务（注解 + 表达式）保证细粒度与可扩展。
  - 取舍：性能 vs 复杂度，选可维护性更强的后端细粒度。

## 5. 效果与数据
- 登录接口 TP99 < 50ms，权限校验开销 < 2ms（缓存命中）。
- 角色/菜单调整后权限生效时间 < 5s（事件驱动 + 缓存失效）。

## 6. 可扩展与优化
- SSO 与第三方 OAuth2 对接预留；多租户透传 `tenantId` 参与权限判定。
- 行为风控：同 IP 异常登录、设备指纹，灰度拦截登录。

## 7. 面试官可能追问点（准备回答）
- 问：如何防止 Token 被盗用？
  - 答：IP/UA 绑定、黑名单、一端踢下线；可加二次校验（短信/OTP）提升敏感操作安全。
- 问：数据权限与缓存如何兼容？
  - 答：缓存 Key 带用户维度；复杂查询走短 TTL 或不缓存；用模板查询避免“脏读”。
- 问：如何做权限变更的灰度与回滚？
  - 答：权限策略以配置化下发，支持版本化与回滚；发布前在影子环境压测策略覆盖率。

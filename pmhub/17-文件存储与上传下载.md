# 文件存储与上传下载

## 1. 场景
- 项目文档/图片/附件
- 任务附件与评论图片
- 工作流表单上传内容

## 2. 存储方案
- 本地存储（默认）：`/upload/{module}/{yyyy}/{MM}/...`
- 云存储（可选）：OSS/MinIO（通过 `pmhub-base` 扩展）

## 3. 接口约定
- 上传：`POST /project/file/upload`（表单 multipart）
  - 参数：`file`、`projectId`、`taskId?`
  - 返回：`{id,name,url,size,type}`
- 下载：`GET /project/file/download/{fileId}`
- 列表：`POST /project/file/list`（条件分页）
- 删除：`POST /project/file/remove`（批量）

## 4. 元数据表（示例）
```sql
CREATE TABLE project_file (
  file_id BIGINT PRIMARY KEY,
  project_id BIGINT,
  task_id BIGINT,
  file_name VARCHAR(200),
  file_path VARCHAR(500),
  file_size BIGINT,
  file_type VARCHAR(50),
  version VARCHAR(20) DEFAULT '1.0',
  upload_user_id BIGINT,
  upload_time DATETIME,
  download_count INT DEFAULT 0
);
```

## 5. 安全与合规
- 鉴权：按项目/任务权限校验下载
- 类型白名单：限制可上传的 MIME/后缀
- 病毒扫描（可选）：对接第三方服务
- 越权访问：签名 URL 或后端流式输出
- 大文件分片：前端分片 + 服务端合并（可选）

## 6. 性能
- CDN 加速（云存储）
- 图片压缩与缩略图
- 断点续传与秒传（ETag/MD5）

## 7. 常见问题
- 预览异常：确认 Content-Type 与跨域头
- 中文文件名：使用 `Content-Disposition` 编码
- 大文件超时：提高反向代理与服务超时阈值

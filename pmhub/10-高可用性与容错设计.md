# 高可用性与容错设计

## 1. 总体思路

以“无状态+冗余+隔离”为原则：入口（网关）多副本、核心服务多实例、数据层主从/哨兵、弹性扩缩容，结合限流/熔断/降级/重试/幂等构建端到端高可用。

## 2. 关键设计

- 网关高可用：多副本 + Nginx/LB；连接池与线程池隔离
- 服务冗余：各微服务 ≥2 实例，滚动发布
- 配置中心：Nacos 集群（生产），本地带缓存的容灾开关
- 断路器：Sentinel 熔断/限流/隔离，快速失败
- 重试与幂等：OpenFeign 重试 + 业务幂等键
- 消息保证：MQ 至少一次 + 幂等消费 + 死信补偿

## 3. 数据层

- MySQL：主从复制/读写分离，备份与恢复演练
- Redis：哨兵/集群模式，持久化与内存上限
- Elastic/MinIO（可选）：副本数与跨可用区

## 4. 故障场景与策略

- 下游慢/挂：熔断 + 降级（返回缓存/兜底数据）
- 短时抖动：退避重试（幂等前提）
- 局部雪崩：流量控制 + 隔离舱（线程池/舱壁）
- 配置故障：本地快照 + 回滚策略

## 5. 演练与评估

- 故障演练：断网、停实例、停库、限流压测
- SLO/SLA：可用性与延迟目标，误差预算
- 可回滚发布：蓝绿/灰度/金丝雀

## 6. 常见问题

- 熔断误触发：颗粒度过粗，需按接口/调用方拆分
- 重试放大流量：仅对读、幂等写启用，设置最大重试与退避
- 缓存击穿/穿透：热点预热 + 本地缓存 + 布隆过滤器

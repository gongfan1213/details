# 定时任务与消息通知

## 1. 概述

- 定时任务模块（`pmhub-job`）基于 Quartz 提供任务编排与执行日志
- 消息通知（`pmhub-base-notice` 可选）基于 RocketMQ 提供异步通知、站内信/邮件/短信扩展

## 2. 定时任务

### 2.1 核心能力
- 在线维护：新增/修改/删除/暂停/恢复
- CRON 表达式：秒级调度
- 执行日志：结果、耗时、异常栈
- 串并行：阻塞策略与并发策略

### 2.2 任务模型（示例）
```sql
CREATE TABLE sys_job (
  job_id BIGINT PRIMARY KEY,
  job_name VARCHAR(64),
  job_group VARCHAR(64),
  invoke_target VARCHAR(500),
  cron_expression VARCHAR(255),
  misfire_policy INT,
  concurrent TINYINT,
  status TINYINT,
  create_time DATETIME,
  update_time DATETIME
);
```

### 2.3 最佳实践
- 任务幂等：基于业务键 + 去重表/Redis SET
- 超时控制：合理 `executeTimeout` + 线程池隔离
- 失败重试：重试次数与退避策略

## 3. 消息通知（RocketMQ）

### 3.1 使用场景
- 任务分配/状态变更提醒
- 截止日期临期提醒
- 审批结果异步通知

### 3.2 设计要点
- 主题/Tag 规划：`notice.task`, `notice.workflow`
- 消费幂等：业务唯一键 + 消费表/Redis
- 顺序与延时：顺序消息用于关键链路，延时消息用于定时提醒

### 3.3 故障处理
- 死信队列：积压报警与人工补偿
- 降级：暂存为站内信，邮件重试

## 4. 接口示例（伪代码）
```java
// 任务调度入口
public interface JobHandler {
  void handle(String params);
}

// 通知
class NoticeMessage { Long userId; String title; String content; String type; }
```

## 5. 常见问题
- Quartz 误触发：检查时区、集群配置、misfire 策略
- MQ 消息堆积：扩容消费者、优化消费逻辑、限速生产
- 幂等失败：核对业务唯一键设计

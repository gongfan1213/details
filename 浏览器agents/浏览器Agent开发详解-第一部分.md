# PuppeteerËØ¶ÁªÜÊïôÁ®ã - Âü∫‰∫éSteel-BrowserÈ°πÁõÆÂÆûÊàò

## ÁõÆÂΩï
1. [ÁéØÂ¢ÉÂáÜÂ§á](#ÁéØÂ¢ÉÂáÜÂ§á)
2. [Âü∫Á°ÄÊ¶ÇÂøµ](#Âü∫Á°ÄÊ¶ÇÂøµ)
3. [Ê†∏ÂøÉÊû∂ÊûÑ](#Ê†∏ÂøÉÊû∂ÊûÑ)
4. [ÂÆûÊàòÁ§∫‰æã](#ÂÆûÊàòÁ§∫‰æã)
5. [È´òÁ∫ßÂäüËÉΩ](#È´òÁ∫ßÂäüËÉΩ)
6. [ÊúÄ‰Ω≥ÂÆûË∑µ](#ÊúÄ‰Ω≥ÂÆûË∑µ)
7. [ÊïÖÈöúÊéíÈô§](#ÊïÖÈöúÊéíÈô§)

## ÁéØÂ¢ÉÂáÜÂ§á

### 1. ÂàõÂª∫Node.jsÈ°πÁõÆ

```bash
# ÂàõÂª∫È°πÁõÆÁõÆÂΩï
mkdir puppeteer-project
cd puppeteer-project

# ÂàùÂßãÂåñpackage.json
npm init -y

# ÂÆâË£ÖPuppeteerÊ†∏ÂøÉ‰æùËµñ
npm install puppeteer-core
npm install puppeteer

# ÂÆâË£ÖTypeScriptÁõ∏ÂÖ≥‰æùËµñ
npm install -D typescript @types/node ts-node

# ÂÆâË£ÖÂºÄÂèëÂ∑•ÂÖ∑
npm install -D nodemon
```

### 2. ÈÖçÁΩÆTypeScript

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 3. ÁéØÂ¢ÉÈÖçÁΩÆ

```bash
# ÂàõÂª∫.envÊñá‰ª∂
cat > .env << EOF
NODE_ENV=development
HOST=0.0.0.0
PORT=3000
CHROME_EXECUTABLE_PATH=/Applications/Google Chrome.app/Contents/MacOS/Google Chrome
CHROME_HEADLESS=false
DEBUG_CHROME_PROCESS=false
EOF
```

### 4. È™åËØÅÂÆâË£Ö

```typescript
// src/test-installation.ts
import puppeteer from 'puppeteer';

async function testPuppeteerInstallation() {
  console.log('üöÄ ÊµãËØïPuppeteerÂÆâË£Ö...');
  
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });
  
  const page = await browser.newPage();
  await page.goto('https://example.com');
  
  const title = await page.title();
  console.log(`‚úÖ È°µÈù¢Ê†áÈ¢ò: ${title}`);
  
  await browser.close();
  console.log('‚úÖ PuppeteerÂÆâË£ÖÊàêÂäüÔºÅ');
}

testPuppeteerInstallation().catch(console.error);
```

## Âü∫Á°ÄÊ¶ÇÂøµ

### 1. PuppeteerÊ†∏ÂøÉÁªÑ‰ª∂

#### BrowserÔºàÊµèËßàÂô®Ôºâ
- **Puppeteer**: ÂÆåÊï¥ÁöÑÊµèËßàÂô®Ëá™Âä®ÂåñÂ∫ì
- **Puppeteer-Core**: ËΩªÈáèÁ∫ßÁâàÊú¨ÔºåÈúÄË¶ÅÊâãÂä®ÁÆ°ÁêÜÊµèËßàÂô®
- **Chrome DevTools Protocol (CDP)**: Â∫ïÂ±ÇÈÄö‰ø°ÂçèËÆÆ

#### BrowserContextÔºàÊµèËßàÂô®‰∏ä‰∏ãÊñáÔºâ
- Áã¨Á´ãÁöÑÊµèËßàÂô®‰ºöËØù
- ÊîØÊåÅÂ§öÊ†áÁ≠æÈ°µ
- ÂèØÈÖçÁΩÆÁî®Êà∑‰ª£ÁêÜ„ÄÅËßÜÂè£Á≠â

#### PageÔºàÈ°µÈù¢Ôºâ
- Âçï‰∏™Ê†áÁ≠æÈ°µ
- ‰∏ªË¶ÅÁöÑ‰∫§‰∫íÂØπË±°
- ÂåÖÂê´DOMÊìç‰Ωú„ÄÅÁΩëÁªúËØ∑Ê±ÇÁ≠âÂäüËÉΩ

### 2. Steel-BrowserÊû∂ÊûÑÊ¶ÇËßà

```
Steel-Browser API
‚îú‚îÄ‚îÄ CDPService (CDPÊúçÂä°)
‚îú‚îÄ‚îÄ SessionService (‰ºöËØùÊúçÂä°)
‚îú‚îÄ‚îÄ SeleniumService (SeleniumÊúçÂä°)
‚îú‚îÄ‚îÄ Browser Context (ÊµèËßàÂô®‰∏ä‰∏ãÊñá)
‚îÇ   ‚îú‚îÄ‚îÄ Page (È°µÈù¢)
‚îÇ   ‚îú‚îÄ‚îÄ CDP Session (CDP‰ºöËØù)
‚îÇ   ‚îî‚îÄ‚îÄ Event Bus (‰∫ã‰ª∂ÊÄªÁ∫ø)
‚îî‚îÄ‚îÄ Plugin System (Êèí‰ª∂Á≥ªÁªü)
```

## Ê†∏ÂøÉÊû∂ÊûÑ

### 1. CDPServiceÁ±ªËØ¶Ëß£

```typescript
// Âü∫‰∫é steel-browser/api/src/services/cdp/cdp.service.ts

import puppeteer, {
  Browser,
  BrowserContext,
  CDPSession,
  HTTPRequest,
  Page,
  Protocol,
  Target,
  TargetType,
} from "puppeteer-core";

export class CDPService extends EventEmitter {
  private logger: FastifyBaseLogger;
  private browserInstance: Browser | null = null;
  private chromeExecPath: string;

  constructor(logger: FastifyBaseLogger) {
    super();
    this.logger = logger;
    this.chromeExecPath = getChromeExecutablePath();
  }

  @traceable
  private async launchInternal(config?: BrowserLauncherOptions): Promise<Browser> {
    const launchTimeout = new Promise((_, reject) => {
      setTimeout(() => {
        reject(new LaunchTimeoutError("Browser launch timeout"));
      }, 30000);
    });

    const launchProcess = (async () => {
      const shouldReuseInstance = this.browserInstance;
      
      const launchArgs = [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--disable-web-security',
        '--disable-features=VizDisplayCompositor',
        ...env.CHROME_ARGS,
      ].filter(Boolean);

      const finalLaunchOptions = {
        headless: env.CHROME_HEADLESS,
        defaultViewport: null,
        args: launchArgs,
        executablePath: this.chromeExecPath,
        timeout: 0,
        env: {
          TZ: timezone,
        },
        userDataDir,
        dumpio: env.DEBUG_CHROME_PROCESS,
      };

      this.logger.info(`[CDPService] Launch Options:`, JSON.stringify(finalLaunchOptions, null, 2));

      // ÂêØÂä®ÊµèËßàÂô®ËøõÁ®ã
      try {
        this.browserInstance = await tracer.startActiveSpan(
          "CDPService.launchBrowser",
          async () => {
            return await puppeteer.launch(finalLaunchOptions);
          },
        ) as unknown as Browser;
      } catch (error) {
        throw new BrowserProcessError(
          error instanceof Error ? error.message : String(error),
          BrowserProcessState.LAUNCH_FAILED,
        );
      }

      // ËÆæÁΩÆÊµèËßàÂô®‰∫ã‰ª∂ÁõëÂê¨
      this.browserInstance.on("error", (error) => {
        this.logger.error(`[CDPService] Browser error: ${error}`);
        this.emit("browserError", error);
      });

      this.browserInstance.on("disconnected", () => {
        this.logger.info(`[CDPService] Browser disconnected`);
        this.browserInstance = null;
        this.emit("browserDisconnected");
      });

      return this.browserInstance;
    })();

    return Promise.race([launchProcess, launchTimeout]) as Promise<Browser>;
  }

  public async createBrowserContext(proxyUrl?: string): Promise<BrowserContext> {
    if (!this.browserInstance) {
      throw new Error("Browser not launched");
    }

    const contextOptions: any = {
      viewport: null,
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36',
      javaScriptEnabled: true,
      bypassCSP: true,
      ignoreHTTPSErrors: true,
    };

    if (proxyUrl) {
      contextOptions.proxy = proxyUrl;
    }

    return await this.browserInstance.createIncognitoBrowserContext(contextOptions);
  }

  public async getPrimaryPage(): Promise<Page> {
    if (!this.browserInstance) {
      throw new Error("Browser not launched");
    }

    const pages = await this.browserInstance.pages();
    if (pages.length === 0) {
      return await this.browserInstance.newPage();
    }
    return pages[0];
  }
}
```

### 2. SessionServiceÁ±ªËØ¶Ëß£

```typescript
// Âü∫‰∫é steel-browser/api/src/services/session.service.ts

export class SessionService {
  private logger: FastifyBaseLogger;
  private cdpService: CDPService;
  private seleniumService: SeleniumService;
  private activeSession: SessionDetails;

  constructor(logger: FastifyBaseLogger) {
    this.logger = logger;
    this.cdpService = new CDPService(logger);
    this.seleniumService = new SeleniumService(logger);
    this.activeSession = new SessionDetails();
  }

  public async startSession(options: {
    sessionId?: string;
    proxyUrl?: string;
    userAgent?: string;
    sessionContext?: {
      cookies?: CookieData[];
      localStorage?: Record<string, Record<string, any>>;
    };
    isSelenium?: boolean;
    logSinkUrl?: string;
    blockAds?: boolean;
    extensions?: string[];
    timezone?: string;
    dimensions?: { width: number; height: number };
    extra?: Record<string, Record<string, string>>;
    credentials: CredentialsOptions;
    skipFingerprintInjection?: boolean;
    userPreferences?: Record<string, any>;
  }): Promise<SessionDetails> {
    
    const {
      sessionId,
      proxyUrl,
      userAgent,
      sessionContext,
      isSelenium = false,
      logSinkUrl,
      blockAds = false,
      extensions = [],
      timezone,
      dimensions,
      extra,
      credentials,
      skipFingerprintInjection = false,
      userPreferences,
    } = options;

    // ËÆæÁΩÆ‰ºöËØùID
    this.activeSession.id = sessionId || uuid7str();

    // ÂàõÂª∫‰ª£ÁêÜÊúçÂä°Âô®ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
    if (proxyUrl) {
      this.activeSession.proxyServer = await this.proxyFactory(proxyUrl);
      await this.activeSession.proxyServer.listen();
    }

    const defaultUserPreferences = {
      plugins: {
        always_open_pdf_externally: true,
        plugins_disabled: ["Chrome PDF Viewer"],
      },
    };

    const mergedUserPreferences = userPreferences
      ? deepMerge(defaultUserPreferences, userPreferences)
      : defaultUserPreferences;

    const browserLauncherOptions: BrowserLauncherOptions = {
      options: {
        headless: env.CHROME_HEADLESS,
        proxyUrl: this.activeSession.proxyServer?.url,
      },
      sessionContext,
      userAgent,
      blockAds,
      extensions,
      logSinkUrl,
      timezone,
      dimensions,
      userDataDir,
      userPreferences: mergedUserPreferences,
      extra,
      credentials,
      skipFingerprintInjection,
    };

    if (isSelenium) {
      // ÂêØÂä®SeleniumÊúçÂä°
      await this.cdpService.shutdown();
      await this.seleniumService.launch(browserLauncherOptions);

      Object.assign(this.activeSession, {
        websocketUrl: "",
        debugUrl: "",
        sessionViewerUrl: "",
        userAgent: userAgent || "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36",
      });
    } else {
      // ÂêØÂä®CDPÊúçÂä°
      await this.cdpService.startNewSession(browserLauncherOptions);

      Object.assign(this.activeSession, {
        websocketUrl: getBaseUrl("ws"),
        debugUrl: getUrl("v1/sessions/debug"),
        debuggerUrl: getUrl("v1/devtools/inspector.html"),
        sessionViewerUrl: getBaseUrl(),
        userAgent: this.cdpService.getUserAgent() || "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36",
      });
    }

    return this.activeSession;
  }
}
```

## ÂÆûÊàòÁ§∫‰æã

### 1. Âü∫Á°ÄÊµèËßàÂô®Ëá™Âä®Âåñ

```typescript
// src/examples/basic-automation.ts
import puppeteer from 'puppeteer';

async function basicAutomation() {
  console.log('üöÄ ÂºÄÂßãÂü∫Á°ÄÊµèËßàÂô®Ëá™Âä®Âåñ...');
  
  const browser = await puppeteer.launch({
    headless: false,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });
  
  try {
    const page = await browser.newPage();
    
    // ËÆæÁΩÆËßÜÂè£
    await page.setViewport({ width: 1200, height: 800 });
    
    // ÂØºËà™Âà∞ÁΩëÁ´ô
    console.log('üì± ÂØºËà™Âà∞ÁôæÂ∫¶...');
    await page.goto('https://www.baidu.com', { 
      waitUntil: 'networkidle2',
      timeout: 30000 
    });
    
    // Á≠âÂæÖÊêúÁ¥¢Ê°ÜÂä†ËΩΩ
    await page.waitForSelector('#kw', { timeout: 10000 });
    
    // ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
    console.log('üîç ÊêúÁ¥¢"PuppeteerÊïôÁ®ã"...');
    await page.type('#kw', 'PuppeteerÊïôÁ®ã');
    
    // ÁÇπÂáªÊêúÁ¥¢ÊåâÈíÆ
    await page.click('#su');
    
    // Á≠âÂæÖÊêúÁ¥¢ÁªìÊûúÂä†ËΩΩ
    await page.waitForSelector('.result', { timeout: 10000 });
    
    // Ëé∑ÂèñÊêúÁ¥¢ÁªìÊûú
    const results = await page.evaluate(() => {
      const resultElements = document.querySelectorAll('.result h3 a');
      return Array.from(resultElements).map(el => ({
        title: el.textContent?.trim(),
        url: el.getAttribute('href')
      })).slice(0, 5);
    });
    
    console.log('üìã ÊêúÁ¥¢ÁªìÊûú:');
    results.forEach((result, index) => {
      console.log(`${index + 1}. ${result.title}`);
      console.log(`   URL: ${result.url}`);
    });
    
    // Êà™Âõæ
    await page.screenshot({ 
      path: 'search-results.png',
      fullPage: true 
    });
    console.log('üì∏ Êà™ÂõæÂ∑≤‰øùÂ≠ò‰∏∫ search-results.png');
    
  } catch (error) {
    console.error('‚ùå Ëá™Âä®ÂåñËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ:', error);
  } finally {
    await browser.close();
    console.log('‚úÖ ÊµèËßàÂô®Â∑≤ÂÖ≥Èó≠');
  }
}

basicAutomation().catch(console.error);
```

### 2. Ë°®ÂçïÂ°´ÂÜôËá™Âä®Âåñ

```typescript
// src/examples/form-filling.ts
import puppeteer from 'puppeteer';

async function formFilling() {
  console.log('üöÄ ÂºÄÂßãË°®ÂçïÂ°´ÂÜôËá™Âä®Âåñ...');
  
  const browser = await puppeteer.launch({
    headless: false,
    ar
## 核心架构

### 1. CDPService类详解

基于 `steel-browser/api/src/services/cdp/cdp.service.ts`：

```typescript
import puppeteer, {
  Browser,
  BrowserContext,
  CDPSession,
  HTTPRequest,
  Page,
  Protocol,
  Target,
  TargetType,
} from "puppeteer-core";

export class CDPService extends EventEmitter {
  private browserInstance: Browser | null;
  private wsEndpoint: string | null;
  private fingerprintData: BrowserFingerprintWithHeaders | null;
  private chromeExecPath: string;
  private primaryPage: Page | null;
  private pluginManager: PluginManager;

  constructor(config: { keepAlive?: boolean }, logger: FastifyBaseLogger) {
    super();
    this.logger = logger;
    this.keepAlive = config.keepAlive ?? false;
    this.browserInstance = null;
    this.wsEndpoint = null;
    this.fingerprintData = null;
    this.chromeExecPath = getChromeExecutablePath();
    this.primaryPage = null;
    this.pluginManager = new PluginManager();
  }

  @traceable
  private async launchInternal(config?: BrowserLauncherOptions): Promise<Browser> {
    const launchTimeout = new Promise<never>((_, reject) => {
      setTimeout(() => {
        reject(new LaunchTimeoutError("Browser launch timeout"));
      }, 30000);
    });

    const launchProcess = (async () => {
      const shouldReuseInstance = this.browserInstance && this.keepAlive;
      
      if (shouldReuseInstance) {
        return this.browserInstance;
      }

      const options = config?.options ?? {};
      const timezone = await this.getTimezone(config);
      const userDataDir = await this.getUserDataDir(config);

      const launchArgs = [
        "--no-sandbox",
        "--disable-dev-shm-usage",
        "--disable-blink-features=AutomationControlled",
        "--disable-web-security",
        "--disable-site-isolation-trials",
        "--disable-features=IsolateOrigins,site-per-process",
        ...env.CHROME_ARGS,
      ].filter(Boolean).filter((arg) => !env.FILTER_CHROME_ARGS.includes(arg));

      const finalLaunchOptions = {
        ...options,
        defaultViewport: null,
        args: launchArgs,
        executablePath: this.chromeExecPath,
        timeout: 0,
        env: {
          TZ: timezone,
        },
        userDataDir,
        dumpio: env.DEBUG_CHROME_PROCESS,
      };

      // Browser process launch - most critical step
      try {
        this.browserInstance = await tracer.startActiveSpan(
          "CDPService.launchBrowser",
          async () => {
            return await puppeteer.launch(finalLaunchOptions);
          },
        ) as unknown as Browser;
      } catch (error) {
        throw new BrowserProcessError(
          error instanceof Error ? error.message : String(error),
          BrowserProcessState.LAUNCH_FAILED,
        );
      }

      return this.browserInstance;
    })();

    return Promise.race([launchProcess, launchTimeout]);
  }
}
```

### 2. 浏览器连接示例

基于 `steel-browser/repl/src/script.ts`：

```typescript
import puppeteer from "puppeteer-core";

async function connectToSteelBrowser() {
  // WebSocket endpoint to connect Browser using Chrome DevTools Protocol (CDP)
  const wsEndpoint = "ws://0.0.0.0:3000";
  const browser = await puppeteer.connect({ browserWSEndpoint: wsEndpoint });
  
  try {
    const page = await browser.newPage();

    // Navigate to a website and log the title
    await page.goto("https://steel.dev");
    console.log(`Page title: ${await page.title()}`);
    
    // 执行一些自动化操作
    await page.type('input[type="text"]', '搜索内容');
    await page.click('button[type="submit"]');
    
    // 等待页面加载
    await page.waitForSelector('.search-results');
    
    // 获取搜索结果
    const results = await page.$$eval('.search-result', elements => 
      elements.map(el => el.textContent)
    );
    
    console.log('搜索结果:', results);
    
  } finally {
    // Cleanup: close all pages and disconnect browser
    await Promise.all((await browser.pages()).map((p) => p.close()));
    await browser.disconnect();  
  }
}

connectToSteelBrowser().catch(console.error);
```

## 实战示例

### 1. 基础搜索示例

```typescript
import puppeteer from 'puppeteer';

async function basicSearchExample() {
  console.log('🔍 开始基础搜索示例...');
  
  const browser = await puppeteer.launch({
    headless: false,
    args: ['--no-sandbox', '--disable-dev-shm-usage']
  });
  
  try {
    const page = await browser.newPage();
    
    // 设置视口大小
    await page.setViewport({ width: 1280, height: 800 });
    
    // 导航到百度
    console.log('🌐 导航到百度首页...');
    await page.goto('https://www.baidu.com', { 
      waitUntil: 'networkidle2' 
    });
    
    // 等待搜索框加载
    await page.waitForSelector('#kw');
    
    // 输入搜索关键词
    console.log('🔍 搜索"Puppeteer教程"...');
    await page.type('#kw', 'Puppeteer教程');
    
    // 点击搜索按钮
    await page.click('#su');
    
    // 等待搜索结果加载
    await page.waitForSelector('#content_left');
    
    // 获取搜索结果
    const searchResults = await page.$$eval('.result', elements => {
      return elements.slice(0, 5).map(el => {
        const titleEl = el.querySelector('h3');
        const linkEl = el.querySelector('a');
        const snippetEl = el.querySelector('.c-abstract');
        
        return {
          title: titleEl?.textContent?.trim() || '',
          link: linkEl?.href || '',
          snippet: snippetEl?.textContent?.trim() || ''
        };
      });
    });
    
    console.log('📋 搜索结果:');
    searchResults.forEach((result, index) => {
      console.log(`${index + 1}. ${result.title}`);
      console.log(`   链接: ${result.link}`);
      console.log(`   摘要: ${result.snippet.substring(0, 100)}...`);
      console.log('');
    });
    
    // 截图保存
    await page.screenshot({ 
      path: 'search_results.png',
      fullPage: true 
    });
    console.log('📸 截图已保存为 search_results.png');
    
  } finally {
    await browser.close();
  }
}

basicSearchExample().catch(console.error);
```

### 2. 表单填写示例

```typescript
import puppeteer from 'puppeteer';

async function formFillingExample() {
  console.log('📝 开始表单填写示例...');
  
  const browser = await puppeteer.launch({
    headless: false,
    args: ['--no-sandbox', '--disable-dev-shm-usage']
  });
  
  try {
    const page = await browser.newPage();
    
    // 导航到测试表单页面
    await page.goto('https://httpbin.org/forms/post', {
      waitUntil: 'networkidle2'
    });
    
    // 填写表单字段
    console.log('✍️ 填写表单...');
    
    await page.type('input[name="custname"]', '张三');
    await page.type('input[name="custtel"]', '138-1234-5678');
    await page.type('input[name="custemail"]', 'zhangsan@example.com');
    
    // 选择下拉菜单
    await page.select('select[name="size"]', 'medium');
    await page.select('select[name="topping"]', 'cheese');
    await page.select('select[name="delivery"]', 'now');
    
    // 填写备注
    await page.type('textarea[name="comments"]', '这是一个测试表单提交');
    
    // 提交表单
    console.log('📤 提交表单...');
    await page.click('input[type="submit"]');
    
    // 等待响应页面加载
    await page.waitForSelector('pre');
    
    // 获取响应内容
    const responseText = await page.$eval('pre', el => el.textContent);
    console.log('📄 表单提交响应:');
    console.log(responseText);
    
    // 截图保存
    await page.screenshot({ 
      path: 'form_response.png',
      fullPage: true 
    });
    console.log('📸 响应截图已保存为 form_response.png');
    
  } finally {
    await browser.close();
  }
}

formFillingExample().catch(console.error);
```

### 3. 数据提取示例

```typescript
import puppeteer from 'puppeteer';
import * as fs from 'fs';

async function dataExtractionExample() {
  console.log('📊 开始数据提取示例...');
  
  const browser = await puppeteer.launch({
    headless: false,
    args: ['--no-sandbox', '--disable-dev-shm-usage']
  });
  
  try {
    const page = await browser.newPage();
    
    // 导航到新闻网站
    await page.goto('https://news.ycombinator.com', {
      waitUntil: 'networkidle2'
    });
    
    // 提取新闻标题和链接
    console.log('📰 提取新闻数据...');
    const newsData = await page.$$eval('.athing', elements => {
      return elements.slice(0, 10).map(el => {
        const titleEl = el.querySelector('.titleline a');
        const scoreEl = el.nextElementSibling?.querySelector('.score');
        const authorEl = el.nextElementSibling?.querySelector('.hnuser');
        
        return {
          title: titleEl?.textContent?.trim() || '',
          link: titleEl?.href || '',
          score: scoreEl?.textContent?.trim() || '0 points',
          author: authorEl?.textContent?.trim() || 'Unknown'
        };
      });
    });
    
    console.log('📋 提取的新闻数据:');
    newsData.forEach((item, index) => {
      console.log(`${index + 1}. ${item.title}`);
      console.log(`   分数: ${item.score} | 作者: ${item.author}`);
      console.log(`   链接: ${item.link}`);
      console.log('');
    });
    
    // 保存数据到JSON文件
    const jsonData = JSON.stringify(newsData, null, 2);
    fs.writeFileSync('news_data.json', jsonData);
    console.log('💾 数据已保存到 news_data.json');
    
    // 生成CSV格式
    const csvHeader = 'Title,Score,Author,Link\n';
    const csvRows = newsData.map(item => 
      `"${item.title}","${item.score}","${item.author}","${item.link}"`
    ).join('\n');
    const csvData = csvHeader + csvRows;
    fs.writeFileSync('news_data.csv', csvData);
    console.log('💾 数据已保存到 news_data.csv');
    
  } finally {
    await browser.close();
  }
}

dataExtractionExample().catch(console.error);
```

## 高级功能

### 1. 指纹注入和反检测

基于Steel-Browser的指纹注入功能：

```typescript
import { FingerprintGenerator, FingerprintInjector } from "fingerprint-generator";
import { BrowserFingerprintWithHeaders } from "fingerprint-generator";

async function setupFingerprint(page: Page) {
  // 生成浏览器指纹
  const fingerprintGenerator = new FingerprintGenerator({
    browsers: [
      { name: "chrome", minVersion: 100 },
      { name: "firefox", minVersion: 100 },
    ],
    devices: ["desktop"],
    locales: ["en-US", "en"],
  });
  
  const fingerprintData: BrowserFingerprintWithHeaders = fingerprintGenerator.getFingerprint();
  
  // 注入指纹到页面
  const fingerprintInjector = new FingerprintInjector();
  await fingerprintInjector.attachFingerprintToPuppeteer(page, fingerprintData);
  
  return fingerprintData;
}

async function stealthBrowserExample() {
  const browser = await puppeteer.launch({
    headless: false,
    args: [
      '--no-sandbox',
      '--disable-blink-features=AutomationControlled',
      '--disable-web-security',
      '--disable-features=IsolateOrigins,site-per-process'
    ]
  });
  
  try {
    const page = await browser.newPage();
    
    // 设置指纹
    await setupFingerprint(page);
    
    // 设置用户代理
    await page.setUserAgent(
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    );
    
    // 设置视口
    await page.setViewport({
      width: 1920,
      height: 1080,
      deviceScaleFactor: 1,
    });
    
    // 导航到反检测测试网站
    await page.goto('https://abrahamjuliot.github.io/creepjs/');
    
    // 等待页面加载
    await page.waitForTimeout(5000);
    
    // 截图保存
    await page.screenshot({ 
      path: 'stealth_test.png',
      fullPage: true 
    });
    
    console.log('✅ 反检测测试完成');
    
  } finally {
    await browser.close();
  }
}
```

### 2. 插件系统

基于Steel-Browser的插件架构：

```typescript
import { BasePlugin } from "./plugins/core/base-plugin.js";
import { Browser, Page } from "puppeteer-core";

// 自定义插件示例
class CustomPlugin extends BasePlugin {
  constructor() {
    super("CustomPlugin");
  }

  async onBrowserLaunch(browser: Browser): Promise<void> {
    console.log("🚀 浏览器启动插件已执行");
  }

  async onPageCreated(page: Page): Promise<void> {
    console.log("📄 页面创建插件已执行");
    
    // 注入自定义脚本
    await page.evaluateOnNewDocument(() => {
      // 隐藏webdriver属性
      Object.defineProperty(navigator, 'webdriver', {
        get: () => undefined,
      });
      
      // 修改plugins
      Object.defineProperty(navigator, 'plugins', {
        get: () => [1, 2, 3, 4, 5],
      });
    });
  }

  async onPageLoaded(page: Page): Promise<void> {
    console.log("📖 页面加载插件已执行");
  }
}

// 使用插件
async function pluginExample() {
  const browser = await puppeteer.launch({
    headless: false
  });
  
  const plugin = new CustomPlugin();
  
  try {
    const page = await browser.newPage();
    
    // 执行插件
    await plugin.onBrowserLaunch(browser);
    await plugin.onPageCreated(page);
    
    await page.goto('https://example.com');
    
    await plugin.onPageLoaded(page);
    
  } finally {
    await browser.close();
  }
}
```

### 3. 网络拦截和修改

```typescript
async function networkInterceptionExample() {
  const browser = await puppeteer.launch({
    headless: false
  });
  
  try {
    const page = await browser.newPage();
    
    // 启用请求拦截
    await page.setRequestInterception(true);
    
    // 拦截请求
    page.on('request', (request) => {
      const url = request.url();
      
      // 阻止广告请求
      if (url.includes('ads') || url.includes('analytics')) {
        request.abort();
        console.log(`🚫 阻止请求: ${url}`);
        return;
      }
      
      // 修改请求头
      const headers = {
        ...request.headers(),
        'X-Custom-Header': 'CustomValue',
        'User-Agent': 'Custom User Agent'
      };
      
      request.continue({ headers });
    });
    
    // 拦截响应
    page.on('response', (response) => {
      const url = response.url();
      const status = response.status();
      
      console.log(`📡 响应: ${status} - ${url}`);
      
      // 修改响应内容
      if (url.includes('example.com') && status === 200) {
        response.text().then(text => {
          console.log('📄 响应内容:', text.substring(0, 100));
        });
      }
    });
    
    await page.goto('https://example.com');
    
  } finally {
    await browser.close();
  }
}
```

## 最佳实践

### 1. 错误处理和重试机制

```typescript
import { RetryManager, RetryOptions } from "./utils/retry.js";

class BrowserAutomation {
  private retryManager: RetryManager;
  
  constructor() {
    this.retryManager = new RetryManager();
  }
  
  async performActionWithRetry<T>(
    action: () => Promise<T>,
    options: RetryOptions = {}
  ): Promise<T> {
    const defaultOptions: RetryOptions = {
      maxRetries: 3,
      delay: 1000,
      backoff: 2,
      ...options
    };
    
    return this.retryManager.retry(action, defaultOptions);
  }
  
  async navigateWithRetry(page: Page, url: string): Promise<void> {
    return this.performActionWithRetry(async () => {
      const response = await page.goto(url, {
        waitUntil: 'networkidle2',
        timeout: 30000
      });
      
      if (!response?.ok()) {
        throw new Error(`导航失败: ${response?.status()} ${response?.statusText()}`);
      }
    });
  }
  
  async clickWithRetry(page: Page, selector: string): Promise<void> {
    return this.performActionWithRetry(async () => {
      await page.waitForSelector(selector, { timeout: 10000 });
      await page.click(selector);
    });
  }
}
```

### 2. 性能优化

```typescript
async function optimizedBrowserExample() {
  const browser = await puppeteer.launch({
    headless: false,
    args: [
      '--no-sandbox',
      '--disable-dev-shm-usage',
      '--disable-gpu',
      '--disable-background-timer-throttling',
      '--disable-backgrounding-occluded-windows',
      '--disable-renderer-backgrounding',
      '--disable-features=TranslateUI',
      '--disable-ipc-flooding-protection',
      '--memory-pressure-off',
      '--max_old_space_size=4096'
    ]
  });
  
  try {
    const page = await browser.newPage();
    
    // 优化页面性能
    await page.setCacheEnabled(true);
    
    // 设置资源拦截
    await page.setRequestInterception(true);
    page.on('request', (request) => {
      const resourceType = request.resourceType();
      
      // 阻止不必要的资源
      if (['image', 'stylesheet', 'font'].includes(resourceType)) {
        request.abort();
      } else {
        request.continue();
      }
    });
    
    // 设置视口
    await page.setViewport({
      width: 1280,
      height: 720,
      deviceScaleFactor: 1
    });
    
    await page.goto('https://example.com');
    
  } finally {
    await browser.close();
  }
}
```

### 3. 资源管理

```typescript
class BrowserManager {
  private browsers: Map<string, Browser> = new Map();
  private maxBrowsers: number = 5;
  
  async getBrowser(sessionId: string): Promise<Browser> {
    if (this.browsers.has(sessionId)) {
      return this.browsers.get(sessionId)!;
    }
    
    if (this.browsers.size >= this.maxBrowsers) {
      // 关闭最旧的浏览器
      const oldestSessionId = this.browsers.keys().next().value;
      await this.closeBrowser(oldestSessionId);
    }
    
    const browser = await puppeteer.launch({
      headless: false,
      args: ['--no-sandbox', '--disable-dev-shm-usage']
    });
    
    this.browsers.set(sessionId, browser);
    return browser;
  }
  
  async closeBrowser(sessionId: string): Promise<void> {
    const browser = this.browsers.get(sessionId);
    if (browser) {
      await browser.close();
      this.browsers.delete(sessionId);
    }
  }
  
  async closeAllBrowsers(): Promise<void> {
    const closePromises = Array.from(this.browsers.values()).map(browser => 
      browser.close()
    );
    await Promise.all(closePromises);
    this.browsers.clear();
  }
}
```

## 故障排除

### 1. 常见错误及解决方案

```typescript
// 1. 浏览器启动失败
async function handleBrowserLaunchError() {
  try {
    const browser = await puppeteer.launch({
      headless: false,
      args: ['--no-sandbox', '--disable-dev-shm-usage']
    });
  } catch (error) {
    console.error('浏览器启动失败:', error);
    
    // 解决方案1: 检查Chrome路径
    const chromePath = '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome';
    const browser = await puppeteer.launch({
      executablePath: chromePath,
      headless: false
    });
    
    // 解决方案2: 使用系统Chrome
    const browser = await puppeteer.launch({
      product: 'chrome',
      headless: false
    });
  }
}

// 2. 页面导航超时
async function handleNavigationTimeout(page: Page) {
  try {
    await page.goto('https://example.com', {
      waitUntil: 'networkidle2',
      timeout: 30000
    });
  } catch (error) {
    console.error('页面导航超时:', error);
    
    // 解决方案: 增加超时时间或使用不同的等待策略
    await page.goto('https://example.com', {
      waitUntil: 'domcontentloaded',
      timeout: 60000
    });
  }
}

// 3. 元素选择器找不到
async function handleSelectorNotFound(page: Page) {
  try {
    await page.click('#non-existent-element');
  } catch (error) {
    console.error('元素未找到:', error);
    
    // 解决方案: 等待元素出现
    await page.waitForSelector('#non-existent-element', {
      timeout: 10000,
      visible: true
    });
    
    // 或者使用更灵活的选择器
    await page.waitForFunction(() => {
      return document.querySelector('#non-existent-element') !== null;
    }, { timeout: 10000 });
  }
}
```

### 2. 调试技巧

```typescript
async function debugBrowserExample() {
  const browser = await puppeteer.launch({
    headless: false,
    devtools: true, // 打开开发者工具
    args: ['--no-sandbox', '--disable-dev-shm-usage']
  });
  
  try {
    const page = await browser.newPage();
    
    // 监听控制台日志
    page.on('console', msg => {
      console.log('浏览器控制台:', msg.text());
    });
    
    // 监听页面错误
    page.on('pageerror', error => {
      console.error('页面错误:', error.message);
    });
    
    // 监听请求失败
    page.on('requestfailed', request => {
      console.error('请求失败:', request.url());
    });
    
    // 设置慢动作模式（调试用）
    await page.setDefaultNavigationTimeout(0);
    await page.setDefaultTimeout(0);
    
    // 添加调试脚本
    await page.evaluateOnNewDocument(() => {
      // 在页面中注入调试信息
      window.debugInfo = {
        userAgent: navigator.userAgent,
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        },
        timestamp: Date.now()
      };
      
      console.log('调试信息:', window.debugInfo);
    });
    
    await page.goto('https://example.com');
    
    // 暂停执行（调试用）
    await page.evaluate(() => {
      debugger;
    });
    
  } finally {
    await browser.close();
  }
}
```

### 3. 性能监控

```typescript
async function monitorPerformance(page: Page) {
  // 启用性能监控
  const client = await page.target().createCDPSession();
  await client.send('Performance.enable');
  
  // 监听性能指标
  client.on('Performance.metrics', data => {
    const metrics = data.metrics;
    console.log('性能指标:', {
      Documents: metrics.find(m => m.name === 'Documents')?.value,
      Frames: metrics.find(m => m.name === 'Frames')?.value,
      JSEventListeners: metrics.find(m => m.name === 'JSEventListeners')?.value,
      Nodes: metrics.find(m => m.name === 'Nodes')?.value,
      LayoutCount: metrics.find(m => m.name === 'LayoutCount')?.value,
      RecalcStyleCount: metrics.find(m => m.name === 'RecalcStyleCount')?.value,
      LayoutDuration: metrics.find(m => m.name === 'LayoutDuration')?.value,
      RecalcStyleDuration: metrics.find(m => m.name === 'RecalcStyleDuration')?.value,
      ScriptDuration: metrics.find(m => m.name === 'ScriptDuration')?.value,
      TaskDuration: metrics.find(m => m.name === 'TaskDuration')?.value,
      JSHeapUsedSize: metrics.find(m => m.name === 'JSHeapUsedSize')?.value,
      JSHeapTotalSize: metrics.find(m => m.name === 'JSHeapTotalSize')?.value,
    });
  });
  
  // 获取内存使用情况
  const memoryInfo = await page.evaluate(() => {
    if ('memory' in performance) {
      return (performance as any).memory;
    }
    return null;
  });
  
  console.log('内存使用情况:', memoryInfo);
}
```

## 总结

本教程基于Steel-Browser项目的实际代码，详细介绍了Puppeteer的使用方法。通过学习本教程，您应该能够：

1. **环境搭建**: 正确安装和配置Puppeteer开发环境
2. **基础操作**: 掌握浏览器启动、页面导航、元素操作等基础功能
3. **高级特性**: 了解指纹注入、插件系统、网络拦截等高级功能
4. **最佳实践**: 学会错误处理、性能优化、资源管理等最佳实践
5. **故障排除**: 掌握常见问题的诊断和解决方法

Puppeteer是一个强大的浏览器自动化工具，结合Steel-Browser项目的架构，可以构建出功能丰富、性能优异的Web自动化解决方案。

